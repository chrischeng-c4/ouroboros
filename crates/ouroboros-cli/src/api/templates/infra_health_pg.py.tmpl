"""
Health check endpoints for Kubernetes probes.

Provides:
- /health/live - Liveness probe (app is running)
- /health/ready - Readiness probe (app can serve traffic)
"""
from fastapi import APIRouter, Response, status
from ouroboros.pg import get_pool

router = APIRouter()


@router.get("/live")
async def liveness():
    """
    Liveness probe - indicates the application is running.

    Returns 200 if the application process is alive.
    Kubernetes will restart the pod if this fails.
    """
    return {"status": "alive"}


@router.get("/ready")
async def readiness(response: Response):
    """
    Readiness probe - indicates the application can serve traffic.

    Checks:
    - Database connectivity

    Returns 200 if ready, 503 if not ready.
    Kubernetes will stop routing traffic if this fails.
    """
    try:
        pool = await get_pool()
        async with pool.acquire() as conn:
            await conn.fetchval("SELECT 1")
        return {"status": "ready", "checks": {"database": "ok"}}
    except Exception as e:
        response.status_code = status.HTTP_503_SERVICE_UNAVAILABLE
        return {
            "status": "not_ready",
            "checks": {"database": f"error: {str(e)}"},
        }
