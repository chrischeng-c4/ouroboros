
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="High-performance Rust-powered Python platform">
      
      
        <meta name="author" content="Chris Cheng">
      
      
        <link rel="canonical" href="https://chrischeng-c4.github.io/ouroboros/archive/OPENTELEMETRY/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>OpenTelemetry Integration Guide - ouroboros</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#opentelemetry-integration-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ouroboros" class="md-header__button md-logo" aria-label="ouroboros" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ouroboros
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OpenTelemetry Integration Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/chrischeng-c4/ouroboros" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../en/user-guide/" class="md-tabs__link">
          
  
  
  English

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../zh-tw/user-guide/" class="md-tabs__link">
          
  
  
  繁體中文

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ouroboros" class="md-nav__button md-logo" aria-label="ouroboros" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ouroboros
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/chrischeng-c4/ouroboros" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    English
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    English
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../en/user-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    繁體中文
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    繁體中文
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zh-tw/user-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用指南
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table of Contents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-opentelemetry" class="md-nav__link">
    <span class="md-ellipsis">
      
        What is OpenTelemetry?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-add-otel-to-data-bridge" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why Add OTel to data-bridge?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud-native-observability-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cloud-Native Observability Benefits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use-telemetry" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use Telemetry
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trace-flow-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trace Flow Diagram
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#component-interaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Component Interaction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-gets-instrumented-automatically" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Gets Instrumented Automatically
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration Points
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      
        Quick Start
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Quick Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-install-opentelemetry-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Install OpenTelemetry SDK
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-configure-otlp-exporter" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Configure OTLP Exporter
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-enable-data-bridge-tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: Enable data-bridge Tracing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-run-your-application" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: Run Your Application
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-view-traces" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 5: View Traces
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Required Packages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optional Dependencies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version-compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        Version Compatibility
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installation Verification
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment Variables
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Environment Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-bridge-specific" class="md-nav__link">
    <span class="md-ellipsis">
      
        data-bridge Specific
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#standard-opentelemetry-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        Standard OpenTelemetry Variables
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programmatic-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Programmatic Configuration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Programmatic Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resource-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resource Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#otlp-exporter-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        OTLP Exporter Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batchspanprocessor-settings" class="md-nav__link">
    <span class="md-ellipsis">
      
        BatchSpanProcessor Settings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sampling-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sampling Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-configuration-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete Configuration Example
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrumented-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Instrumented Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Instrumented Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    <span class="md-ellipsis">
      
        Queries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find" class="md-nav__link">
    <span class="md-ellipsis">
      
        find()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#count" class="md-nav__link">
    <span class="md-ellipsis">
      
        count()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#first" class="md-nav__link">
    <span class="md-ellipsis">
      
        first()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exists" class="md-nav__link">
    <span class="md-ellipsis">
      
        exists()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sessions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sessions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sessions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#open-session-context-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        open() / Session Context Manager
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flush" class="md-nav__link">
    <span class="md-ellipsis">
      
        flush()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#commit" class="md-nav__link">
    <span class="md-ellipsis">
      
        commit()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rollback" class="md-nav__link">
    <span class="md-ellipsis">
      
        rollback()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relationships" class="md-nav__link">
    <span class="md-ellipsis">
      
        Relationships
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Relationships">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lazy-loading-select-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lazy Loading (select strategy)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eager-loading-selectinload-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Eager Loading (selectinload strategy)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#span-attributes-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        Span Attributes Reference
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Span Attributes Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#standard-opentelemetry-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Standard OpenTelemetry Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Query Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Result Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Session Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relationship-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Relationship Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-example-span" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete Example Span
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#otlp-backends" class="md-nav__link">
    <span class="md-ellipsis">
      
        OTLP Backends
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="OTLP Backends">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jaeger-local-development" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jaeger (Local Development)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grafana-cloud-saas" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grafana Cloud (SaaS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datadog-apm" class="md-nav__link">
    <span class="md-ellipsis">
      
        DataDog APM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#new-relic" class="md-nav__link">
    <span class="md-ellipsis">
      
        New Relic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#honeycombio" class="md-nav__link">
    <span class="md-ellipsis">
      
        Honeycomb.io
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-x-ray-via-adot-collector" class="md-nav__link">
    <span class="md-ellipsis">
      
        AWS X-Ray (via ADOT Collector)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-variable-template" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment Variable Template
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overhead-when-enabled-vs-disabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overhead When Enabled vs Disabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sampling-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sampling Strategies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-exporting-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Batch Exporting Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fast-path-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fast-Path Optimization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cardinality-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cardinality Considerations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#development-vs-production-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development vs Production Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sampling-rates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sampling Rates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resource-attribute-naming" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resource Attribute Naming
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#span-attribute-limits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Span Attribute Limits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations-pii-in-spans" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Considerations (PII in Spans)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graceful-degradation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graceful Degradation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#n1-query-detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        N+1 Query Detection
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="N+1 Query Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-identify-n1-queries-in-traces" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to Identify N+1 Queries in Traces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-span-counts-to-detect-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using Span Counts to Detect Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eager-loading-as-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Eager Loading as Solution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beforeafter-trace-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Before/After Trace Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatic-n1-detection-future" class="md-nav__link">
    <span class="md-ellipsis">
      
        Automatic N+1 Detection (Future)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-issues-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Issues and Solutions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Issues and Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#issue-no-traces-appearing-in-backend" class="md-nav__link">
    <span class="md-ellipsis">
      
        Issue: "No traces appearing in backend"
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#issue-connection-errors-to-otlp-collector" class="md-nav__link">
    <span class="md-ellipsis">
      
        Issue: "Connection errors to OTLP collector"
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#issue-performance-degradation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Issue: "Performance degradation"
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#issue-missing-spans" class="md-nav__link">
    <span class="md-ellipsis">
      
        Issue: "Missing spans"
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#issue-high-cardinality-warnings" class="md-nav__link">
    <span class="md-ellipsis">
      
        Issue: "High cardinality warnings"
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging Tips
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging Tips">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-verbose-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enable Verbose Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-exporter-development" class="md-nav__link">
    <span class="md-ellipsis">
      
        Console Exporter (Development)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-span-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        Verify Span Export
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-otlp-connectivity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test OTLP Connectivity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapi-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        FastAPI Integration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#standalone-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Standalone Scripts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pytest-integration-future" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pytest Integration (Future)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Reference
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#telemetry-module" class="md-nav__link">
    <span class="md-ellipsis">
      
        telemetry Module
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="telemetry Module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#is_tracing_enabled-bool" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_tracing_enabled() -&gt; bool
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_tracer-optionaltracer" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_tracer() -&gt; Optional[Tracer]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_meter-optionalmeter" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_meter() -&gt; Optional[Meter]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#span-context-managers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Span Context Managers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Span Context Managers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create_query_span" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_query_span(...)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create_session_span" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_session_span(...)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create_relationship_span" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_relationship_span(...)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helper-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Helper Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Helper Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add_exceptionspan-exception" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_exception(span, exception)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_span_result" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_span_result(...)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decorators" class="md-nav__link">
    <span class="md-ellipsis">
      
        Decorators
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Decorators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instrument_span" class="md-nav__link">
    <span class="md-ellipsis">
      
        @instrument_span(...)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instrument_query" class="md-nav__link">
    <span class="md-ellipsis">
      
        @instrument_query(...)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instrument_session" class="md-nav__link">
    <span class="md-ellipsis">
      
        @instrument_session(...)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connectionpoolmetrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        ConnectionPoolMetrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Constants
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Constants">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spanattributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        SpanAttributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metricnames" class="md-nav__link">
    <span class="md-ellipsis">
      
        MetricNames
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Future Enhancements
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Future Enhancements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#planned-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Planned Features
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Planned Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-automatic-n1-detection-warnings" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Automatic N+1 Detection Warnings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-metrics-export-beyond-connection-pool" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Metrics Export (Beyond Connection Pool)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-custom-span-processors" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Custom Span Processors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-span-links-for-async-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Span Links for Async Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-sampling-based-on-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Sampling Based on Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-query-plan-export" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Query Plan Export
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#community-contributions-welcome" class="md-nav__link">
    <span class="md-ellipsis">
      
        Community Contributions Welcome
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#official-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Official Documentation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-bridge-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        data-bridge Documentation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend-specific-docs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend-Specific Docs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Code Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#support" class="md-nav__link">
    <span class="md-ellipsis">
      
        Support
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Support">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-help" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Help
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reporting-bugs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reporting Bugs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="opentelemetry-integration-guide">OpenTelemetry Integration Guide<a class="headerlink" href="#opentelemetry-integration-guide" title="Permanent link">&para;</a></h1>
<p>Comprehensive guide to distributed tracing and observability in data-bridge PostgreSQL ORM.</p>
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#quick-start">Quick Start</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#instrumented-operations">Instrumented Operations</a></li>
<li><a href="#span-attributes-reference">Span Attributes Reference</a></li>
<li><a href="#otlp-backends">OTLP Backends</a></li>
<li><a href="#performance-considerations">Performance Considerations</a></li>
<li><a href="#best-practices">Best Practices</a></li>
<li><a href="#n1-query-detection">N+1 Query Detection</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#integration-examples">Integration Examples</a></li>
<li><a href="#api-reference">API Reference</a></li>
<li><a href="#future-enhancements">Future Enhancements</a></li>
</ol>
<hr />
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<h3 id="what-is-opentelemetry">What is OpenTelemetry?<a class="headerlink" href="#what-is-opentelemetry" title="Permanent link">&para;</a></h3>
<p>OpenTelemetry (OTel) is an open-source observability framework that provides:</p>
<ul>
<li><strong>Traces</strong>: Track requests across distributed systems</li>
<li><strong>Metrics</strong>: Collect performance and resource utilization data</li>
<li><strong>Logs</strong>: Structured logging with correlation to traces</li>
<li><strong>Vendor-Neutral</strong>: Works with Jaeger, Grafana, DataDog, New Relic, and more</li>
</ul>
<h3 id="why-add-otel-to-data-bridge">Why Add OTel to data-bridge?<a class="headerlink" href="#why-add-otel-to-data-bridge" title="Permanent link">&para;</a></h3>
<p>data-bridge includes built-in OpenTelemetry support to provide:</p>
<ol>
<li><strong>Database Performance Insights</strong>: See exactly how long queries take and what they do</li>
<li><strong>N+1 Query Detection</strong>: Identify performance anti-patterns automatically</li>
<li><strong>Session Lifecycle Tracking</strong>: Monitor transaction boundaries and state changes</li>
<li><strong>Relationship Loading Analysis</strong>: Compare lazy vs eager loading strategies</li>
<li><strong>Production Debugging</strong>: Trace requests end-to-end in distributed systems</li>
<li><strong>Cloud-Native Observability</strong>: Integrate with modern observability platforms</li>
</ol>
<h3 id="cloud-native-observability-benefits">Cloud-Native Observability Benefits<a class="headerlink" href="#cloud-native-observability-benefits" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Distributed Tracing</strong>: Follow requests across microservices</li>
<li><strong>Performance Profiling</strong>: Identify bottlenecks in database operations</li>
<li><strong>Error Tracking</strong>: Capture exceptions with full context</li>
<li><strong>SLO Monitoring</strong>: Track service level objectives and latency percentiles</li>
<li><strong>Cost Optimization</strong>: Identify expensive queries for optimization</li>
</ul>
<h3 id="when-to-use-telemetry">When to Use Telemetry<a class="headerlink" href="#when-to-use-telemetry" title="Permanent link">&para;</a></h3>
<p><strong>Use OpenTelemetry when:</strong>
- Running in production with distributed services
- Debugging performance issues or N+1 queries
- Building cloud-native applications
- Need observability in microservices
- Using APM tools (DataDog, New Relic, etc.)</p>
<p><strong>Don't use telemetry when:</strong>
- Local development (unless explicitly testing traces)
- Running benchmarks (adds ~1-2ms overhead per span)
- Privacy-sensitive environments (spans may contain query details)
- Resource-constrained environments (minimal overhead, but not zero)</p>
<p><strong>Note</strong>: When disabled, telemetry has <strong>zero overhead</strong> due to fast-path optimization.</p>
<hr />
<h2 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">&para;</a></h2>
<h3 id="trace-flow-diagram">Trace Flow Diagram<a class="headerlink" href="#trace-flow-diagram" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>│                     HTTP Request                            │
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│                  (FastAPI, Flask, etc.)                     │
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>└─────────────────┬───────────────────────────────────────────┘
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                  │ Trace ID: abc123
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                  │ Span ID: def456
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                  ▼
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>│         HTTP Span (from FastAPI auto-instrumentation)       │
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>│         ┌─────────────────────────────────────────┐         │
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>│         │ http.method: GET                        │         │
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>│         │ http.route: /users/{user_id}            │         │
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>│         │ http.status_code: 200                   │         │
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>│         └─────────────────────────────────────────┘         │
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>└─────────────────┬───────────────────────────────────────────┘
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>                  │ Parent Span ID: def456
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                  │ Child Span ID: ghi789
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                  ▼
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>│         data-bridge ORM Spans                               │
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>│                                                              │
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>│  ┌──────────────────────────────────────────────┐          │
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>│  │ db.query.find                                │          │
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>│  │ ├─ db.system: postgresql                     │          │
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>│  │ ├─ db.collection.name: users                 │          │
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>│  │ ├─ db.operation.name: find                   │          │
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>│  │ ├─ db.query.filters_count: 1                 │          │
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>│  │ └─ db.result.count: 1                        │          │
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>│  └──────────────────────────────────────────────┘          │
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>│           │                                                  │
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>│           ▼                                                  │
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>│  ┌──────────────────────────────────────────────┐          │
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>│  │ db.relationship.select (lazy loading)        │          │
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>│  │ ├─ db.relationship.name: posts               │          │
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>│  │ ├─ db.relationship.strategy: select          │          │
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>│  │ ├─ db.relationship.cache_hit: false          │          │
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>│  │ └─ db.result.count: 5                        │          │
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>│  └──────────────────────────────────────────────┘          │
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>│           │                                                  │
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>│           ▼                                                  │
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>│  ┌──────────────────────────────────────────────┐          │
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>│  │ db.session.flush                             │          │
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>│  │ ├─ db.session.pending_count: 3               │          │
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>│  │ ├─ db.session.dirty_count: 2                 │          │
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>│  │ └─ db.session.deleted_count: 0               │          │
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>│  └──────────────────────────────────────────────┘          │
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>│           │                                                  │
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>│           ▼                                                  │
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>│  ┌──────────────────────────────────────────────┐          │
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>│  │ db.session.commit                            │          │
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>│  └──────────────────────────────────────────────┘          │
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>│                                                              │
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>└─────────────────┬───────────────────────────────────────────┘
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                  │
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>                  ▼
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>│         PostgreSQL Database                                 │
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>│         (Actual SQL execution)                              │
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>└─────────────────┬───────────────────────────────────────────┘
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>                  │
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>                  ▼
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>│         OTLP Exporter (gRPC or HTTP)                        │
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>│         - BatchSpanProcessor                                │
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>│         - Async export every 5s or 512 spans                │
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>└─────────────────┬───────────────────────────────────────────┘
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>                  │
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>                  ▼
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>│         Observability Backend                               │
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>│         Jaeger / Grafana / DataDog / etc.                   │
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>└─────────────────────────────────────────────────────────────┘
</code></pre></div>
<h3 id="component-interaction">Component Interaction<a class="headerlink" href="#component-interaction" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>┌──────────────────┐
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>│ data-bridge ORM  │
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>└────────┬─────────┘
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>         │
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>         │ Uses telemetry module
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>         ▼
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>┌──────────────────────────────────────┐
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>│ telemetry.py                         │
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>│ ├─ get_tracer()                      │
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>│ ├─ create_query_span()               │
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>│ ├─ create_session_span()             │
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>│ ├─ create_relationship_span()        │
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>│ └─ ConnectionPoolMetrics             │
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>└────────┬─────────────────────────────┘
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>         │
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>         │ Calls OpenTelemetry API
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>         ▼
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>┌──────────────────────────────────────┐
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>│ OpenTelemetry SDK (optional)         │
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>│ ├─ TracerProvider                    │
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>│ ├─ MeterProvider                     │
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>│ └─ SpanProcessor                     │
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>└────────┬─────────────────────────────┘
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>         │
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>         │ Exports spans
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>         ▼
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>┌──────────────────────────────────────┐
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>│ OTLP Exporter (gRPC/HTTP)            │
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>│ ├─ Batch processing                  │
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>│ ├─ Compression (gzip)                │
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>│ └─ Retry logic                       │
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>└────────┬─────────────────────────────┘
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>         │
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>         │ Sends to backend
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>         ▼
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>┌──────────────────────────────────────┐
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>│ Backend (Jaeger/Grafana/etc.)        │
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>└──────────────────────────────────────┘
</code></pre></div>
<h3 id="what-gets-instrumented-automatically">What Gets Instrumented Automatically<a class="headerlink" href="#what-gets-instrumented-automatically" title="Permanent link">&para;</a></h3>
<p>When you use data-bridge ORM operations, spans are <strong>automatically created</strong> for:</p>
<ol>
<li><strong>Queries</strong>: <code>find()</code>, <code>count()</code>, <code>aggregate()</code>, <code>exists()</code>, <code>first()</code></li>
<li><strong>Sessions</strong>: <code>open()</code>, <code>close()</code>, <code>flush()</code>, <code>commit()</code>, <code>rollback()</code></li>
<li><strong>Relationships</strong>: Lazy loading (on-demand) and eager loading (batch)</li>
<li><strong>Errors</strong>: Exceptions are automatically recorded with stack traces</li>
</ol>
<p><strong>No code changes required</strong> - just enable tracing via environment variable!</p>
<h3 id="integration-points">Integration Points<a class="headerlink" href="#integration-points" title="Permanent link">&para;</a></h3>
<p>data-bridge telemetry integrates at these layers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Layer 1: Query execution (query.py)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1"># → Creates: db.query.find span</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1"># Layer 2: Session management (session.py)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1"># → Creates: db.session.flush span</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="c1"># Layer 3: Relationship loading (relationships.py, options.py)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user</span><span class="o">.</span><span class="n">posts</span>  <span class="c1"># Lazy load</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="c1"># → Creates: db.relationship.select span</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="c1"># Layer 4: Eager loading (options.py)</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">selectinload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">posts</span><span class="p">))</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="c1"># → Creates: db.relationship.selectinload span</span>
</code></pre></div>
<hr />
<h2 id="quick-start">Quick Start<a class="headerlink" href="#quick-start" title="Permanent link">&para;</a></h2>
<p>Get tracing working in <strong>5 minutes</strong>:</p>
<h3 id="step-1-install-opentelemetry-sdk">Step 1: Install OpenTelemetry SDK<a class="headerlink" href="#step-1-install-opentelemetry-sdk" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>pip<span class="w"> </span>install<span class="w"> </span>opentelemetry-api<span class="w"> </span>opentelemetry-sdk<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">            </span>opentelemetry-exporter-otlp-proto-grpc
</code></pre></div>
<h3 id="step-2-configure-otlp-exporter">Step 2: Configure OTLP Exporter<a class="headerlink" href="#step-2-configure-otlp-exporter" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracerProvider</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchSpanProcessor</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.exporter.otlp.proto.grpc.trace_exporter</span><span class="w"> </span><span class="kn">import</span> <span class="n">OTLPSpanExporter</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resource</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1"># Configure resource attributes</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="s2">&quot;service.name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-api&quot;</span><span class="p">,</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="s2">&quot;service.version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="s2">&quot;deployment.environment&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="p">})</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="c1"># Set up tracer provider</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">)</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="c1"># Configure OTLP exporter (to Jaeger, Grafana, etc.)</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="n">otlp_exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;http://localhost:4317&quot;</span><span class="p">,</span>  <span class="c1"># OTLP gRPC endpoint</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Use TLS in production</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="c1"># Add batch processor for async export</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchSpanProcessor</span><span class="p">(</span><span class="n">otlp_exporter</span><span class="p">)</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="c1"># Set as global tracer provider</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
</code></pre></div>
<h3 id="step-3-enable-data-bridge-tracing">Step 3: Enable data-bridge Tracing<a class="headerlink" href="#step-3-enable-data-bridge-tracing" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DATA_BRIDGE_TRACING_ENABLED</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<h3 id="step-4-run-your-application">Step 4: Run Your Application<a class="headerlink" href="#step-4-run-your-application" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="c1"># Normal ORM usage - tracing happens automatically!</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="s2">&quot;postgresql://localhost/mydb&quot;</span><span class="p">)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    <span class="c1"># This query creates a span automatically</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="si">}</span><span class="s2"> users&quot;</span><span class="p">)</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<h3 id="step-5-view-traces">Step 5: View Traces<a class="headerlink" href="#step-5-view-traces" title="Permanent link">&para;</a></h3>
<p>Open your observability backend:</p>
<ul>
<li><strong>Jaeger</strong>: http://localhost:16686</li>
<li><strong>Grafana Cloud</strong>: Your Grafana instance</li>
<li><strong>DataDog</strong>: app.datadoghq.com/apm/traces</li>
</ul>
<p><strong>That's it!</strong> Your database operations are now traced.</p>
<hr />
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h2>
<h3 id="required-packages">Required Packages<a class="headerlink" href="#required-packages" title="Permanent link">&para;</a></h3>
<p><strong>Minimum (API only)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>pip<span class="w"> </span>install<span class="w"> </span>opentelemetry-api
</code></pre></div></p>
<p>This allows data-bridge to import OpenTelemetry types, but <strong>no spans will be exported</strong> without the SDK.</p>
<p><strong>Recommended (SDK + OTLP Exporter)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>pip<span class="w"> </span>install<span class="w"> </span>opentelemetry-api<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">            </span>opentelemetry-sdk<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">            </span>opentelemetry-exporter-otlp-proto-grpc
</code></pre></div></p>
<h3 id="optional-dependencies">Optional Dependencies<a class="headerlink" href="#optional-dependencies" title="Permanent link">&para;</a></h3>
<p><strong>For specific backends</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Jaeger (deprecated, use OTLP instead)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>pip<span class="w"> </span>install<span class="w"> </span>opentelemetry-exporter-jaeger
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="c1"># Console output (debugging)</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="c1"># (included in opentelemetry-sdk)</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="c1"># HTTP/JSON exporter (alternative to gRPC)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>pip<span class="w"> </span>install<span class="w"> </span>opentelemetry-exporter-otlp-proto-http
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="c1"># Prometheus metrics</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>pip<span class="w"> </span>install<span class="w"> </span>opentelemetry-exporter-prometheus
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="c1"># FastAPI auto-instrumentation</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>pip<span class="w"> </span>install<span class="w"> </span>opentelemetry-instrumentation-fastapi
</code></pre></div>
<h3 id="version-compatibility">Version Compatibility<a class="headerlink" href="#version-compatibility" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Package</th>
<th>Minimum Version</th>
<th>Tested Version</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>opentelemetry-api</code></td>
<td>1.20.0</td>
<td>1.28.0</td>
</tr>
<tr>
<td><code>opentelemetry-sdk</code></td>
<td>1.20.0</td>
<td>1.28.0</td>
</tr>
<tr>
<td><code>opentelemetry-exporter-otlp-proto-grpc</code></td>
<td>1.20.0</td>
<td>1.28.0</td>
</tr>
<tr>
<td><code>data-bridge</code></td>
<td>0.1.0</td>
<td>latest</td>
</tr>
<tr>
<td>Python</td>
<td>3.12+</td>
<td>3.12</td>
</tr>
</tbody>
</table>
<h3 id="installation-verification">Installation Verification<a class="headerlink" href="#installation-verification" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Check if OpenTelemetry is available</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">OTEL_AVAILABLE</span><span class="p">,</span> <span class="n">is_tracing_enabled</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenTelemetry SDK available: </span><span class="si">{</span><span class="n">OTEL_AVAILABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracing enabled: </span><span class="si">{</span><span class="n">is_tracing_enabled</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Expected output:
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>OpenTelemetry SDK available: True
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>Tracing enabled: True
</code></pre></div></p>
<hr />
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2>
<h3 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">&para;</a></h3>
<p>data-bridge uses standard OpenTelemetry environment variables plus one custom variable:</p>
<h4 id="data-bridge-specific">data-bridge Specific<a class="headerlink" href="#data-bridge-specific" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Enable/disable tracing (default: true if SDK installed)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DATA_BRIDGE_TRACING_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># Disable tracing</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DATA_BRIDGE_TRACING_ENABLED</span><span class="o">=</span><span class="nb">false</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="c1"># Or: export DATA_BRIDGE_TRACING_ENABLED=0</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1"># Or: export DATA_BRIDGE_TRACING_ENABLED=no</span>
</code></pre></div>
<h4 id="standard-opentelemetry-variables">Standard OpenTelemetry Variables<a class="headerlink" href="#standard-opentelemetry-variables" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># OTLP exporter endpoint (gRPC)</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_ENDPOINT</span><span class="o">=</span>http://localhost:4317
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="c1"># Use insecure connection (no TLS)</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_INSECURE</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="c1"># Authentication headers (for cloud backends)</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_HEADERS</span><span class="o">=</span><span class="s2">&quot;api-key=your-key-here&quot;</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="c1"># Service identification</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SERVICE_NAME</span><span class="o">=</span>my-api
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SERVICE_VERSION</span><span class="o">=</span><span class="m">1</span>.0.0
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_RESOURCE_ATTRIBUTES</span><span class="o">=</span><span class="s2">&quot;deployment.environment=production,team=backend&quot;</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="c1"># Sampling configuration</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_TRACES_SAMPLER</span><span class="o">=</span>traceidratio
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_TRACES_SAMPLER_ARG</span><span class="o">=</span><span class="m">0</span>.1<span class="w">  </span><span class="c1"># Sample 10% of traces</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="c1"># Span limits</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT</span><span class="o">=</span><span class="m">4096</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT</span><span class="o">=</span><span class="m">128</span>
</code></pre></div>
<h3 id="programmatic-configuration">Programmatic Configuration<a class="headerlink" href="#programmatic-configuration" title="Permanent link">&para;</a></h3>
<h4 id="resource-attributes">Resource Attributes<a class="headerlink" href="#resource-attributes" title="Permanent link">&para;</a></h4>
<p>Define service metadata attached to all spans:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resource</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="c1"># Service identification (recommended)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="s2">&quot;service.name&quot;</span><span class="p">:</span> <span class="s2">&quot;user-api&quot;</span><span class="p">,</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="s2">&quot;service.version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.3.1&quot;</span><span class="p">,</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="s2">&quot;service.namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    <span class="c1"># Deployment info</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="s2">&quot;deployment.environment&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>  <span class="c1"># development, staging, production</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="c1"># Infrastructure</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="s2">&quot;host.name&quot;</span><span class="p">:</span> <span class="s2">&quot;app-server-01&quot;</span><span class="p">,</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="s2">&quot;host.type&quot;</span><span class="p">:</span> <span class="s2">&quot;ec2&quot;</span><span class="p">,</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>    <span class="s2">&quot;cloud.provider&quot;</span><span class="p">:</span> <span class="s2">&quot;aws&quot;</span><span class="p">,</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>    <span class="s2">&quot;cloud.region&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>    <span class="c1"># Team/ownership</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>    <span class="s2">&quot;team&quot;</span><span class="p">:</span> <span class="s2">&quot;backend-team&quot;</span><span class="p">,</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>    <span class="c1"># Custom attributes</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>    <span class="s2">&quot;app.feature.flags&quot;</span><span class="p">:</span> <span class="s2">&quot;feature-x-enabled&quot;</span><span class="p">,</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="p">})</span>
</code></pre></div>
<h4 id="otlp-exporter-configuration">OTLP Exporter Configuration<a class="headerlink" href="#otlp-exporter-configuration" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.exporter.otlp.proto.grpc.trace_exporter</span><span class="w"> </span><span class="kn">import</span> <span class="n">OTLPSpanExporter</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c1"># Basic configuration</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;http://localhost:4317&quot;</span><span class="p">,</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Set to False for TLS in production</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="p">)</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="c1"># Advanced configuration</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;https://otlp.example.com:4317&quot;</span><span class="p">,</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Use TLS</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        <span class="s2">&quot;api-key&quot;</span><span class="p">:</span> <span class="s2">&quot;your-api-key&quot;</span><span class="p">,</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>        <span class="s2">&quot;tenant-id&quot;</span><span class="p">:</span> <span class="s2">&quot;abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>    <span class="p">},</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># Request timeout in seconds</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span>  <span class="c1"># Compress payloads</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="p">)</span>
</code></pre></div>
<h4 id="batchspanprocessor-settings">BatchSpanProcessor Settings<a class="headerlink" href="#batchspanprocessor-settings" title="Permanent link">&para;</a></h4>
<p>Optimize span export performance:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchSpanProcessor</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchSpanProcessor</span><span class="p">(</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="n">exporter</span><span class="p">,</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="c1"># How often to export (milliseconds)</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="n">schedule_delay_millis</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>  <span class="c1"># Export every 5 seconds</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>    <span class="c1"># Max batch size before forcing export</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="n">max_export_batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>   <span class="c1"># Export when 512 spans collected</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="c1"># Max queue size (drop spans if exceeded)</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="n">max_queue_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="c1"># Export timeout</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="n">export_timeout_millis</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span>  <span class="c1"># 30 seconds</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="p">)</span>
</code></pre></div>
<p><strong>Production recommendations</strong>:
- <code>schedule_delay_millis</code>: 5000-10000 (balance latency vs overhead)
- <code>max_export_batch_size</code>: 512-1024 (reduce network calls)
- <code>max_queue_size</code>: 2048-4096 (prevent memory issues)</p>
<h4 id="sampling-configuration">Sampling Configuration<a class="headerlink" href="#sampling-configuration" title="Permanent link">&para;</a></h4>
<p>Reduce overhead by sampling a subset of traces:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="n">TraceIdRatioBased</span><span class="p">,</span>  <span class="c1"># Sample by ratio</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="n">ParentBased</span><span class="p">,</span>        <span class="c1"># Follow parent decision</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="n">ALWAYS_ON</span><span class="p">,</span>          <span class="c1"># Sample everything</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="n">ALWAYS_OFF</span><span class="p">,</span>         <span class="c1"># Sample nothing</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="p">)</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="c1"># Sample 10% of traces (recommended for high-traffic production)</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="n">sampler</span> <span class="o">=</span> <span class="n">TraceIdRatioBased</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="c1"># Always sample (development)</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="n">sampler</span> <span class="o">=</span> <span class="n">ALWAYS_ON</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="c1"># Never sample (disable tracing via SDK)</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="n">sampler</span> <span class="o">=</span> <span class="n">ALWAYS_OFF</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="c1"># Parent-based (follow parent span&#39;s sampling decision)</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="n">sampler</span> <span class="o">=</span> <span class="n">ParentBased</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">TraceIdRatioBased</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="c1"># Use sampler in tracer provider</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">(</span><span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">)</span>
</code></pre></div>
<p><strong>Sampling strategies</strong>:
- <strong>Development</strong>: <code>ALWAYS_ON</code> (100%)
- <strong>Low-traffic production</strong>: <code>TraceIdRatioBased(1.0)</code> (100%)
- <strong>Medium-traffic production</strong>: <code>TraceIdRatioBased(0.5)</code> (50%)
- <strong>High-traffic production</strong>: <code>TraceIdRatioBased(0.1)</code> (10%)
- <strong>Very high-traffic</strong>: <code>TraceIdRatioBased(0.01)</code> (1%)</p>
<h3 id="complete-configuration-example">Complete Configuration Example<a class="headerlink" href="#complete-configuration-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracerProvider</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchSpanProcessor</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">TraceIdRatioBased</span><span class="p">,</span> <span class="n">ParentBased</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.exporter.otlp.proto.grpc.trace_exporter</span><span class="w"> </span><span class="kn">import</span> <span class="n">OTLPSpanExporter</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resource</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure_telemetry</span><span class="p">():</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure OpenTelemetry for production.&quot;&quot;&quot;</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>    <span class="c1"># 1. Define resource attributes</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>        <span class="s2">&quot;service.name&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SERVICE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;my-api&quot;</span><span class="p">),</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>        <span class="s2">&quot;service.version&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SERVICE_VERSION&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">),</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>        <span class="s2">&quot;deployment.environment&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENVIRONMENT&quot;</span><span class="p">,</span> <span class="s2">&quot;production&quot;</span><span class="p">),</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>    <span class="p">})</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>    <span class="c1"># 2. Configure sampler (10% sampling for production)</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>    <span class="n">sampler</span> <span class="o">=</span> <span class="n">ParentBased</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">TraceIdRatioBased</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>    <span class="c1"># 3. Create tracer provider</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">(</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>        <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>        <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>    <span class="p">)</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>    <span class="c1"># 4. Configure OTLP exporter</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>    <span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>        <span class="n">endpoint</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OTEL_EXPORTER_OTLP_ENDPOINT&quot;</span><span class="p">,</span> <span class="s2">&quot;http://localhost:4317&quot;</span><span class="p">),</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>        <span class="n">insecure</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OTEL_EXPORTER_OTLP_INSECURE&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>    <span class="p">)</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>    <span class="c1"># 5. Add batch processor</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchSpanProcessor</span><span class="p">(</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>        <span class="n">exporter</span><span class="p">,</span>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>        <span class="n">schedule_delay_millis</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>        <span class="n">max_export_batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>    <span class="p">)</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>    <span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>    <span class="c1"># 6. Set as global provider</span>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>    <span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenTelemetry configured: </span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">attributes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="c1"># Call this at application startup</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a><span class="n">configure_telemetry</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="instrumented-operations">Instrumented Operations<a class="headerlink" href="#instrumented-operations" title="Permanent link">&para;</a></h2>
<h3 id="queries">Queries<a class="headerlink" href="#queries" title="Permanent link">&para;</a></h3>
<p>All query operations automatically create spans with detailed attributes.</p>
<h4 id="find"><code>find()</code><a class="headerlink" href="#find" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>Name: db.query.find
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>Attributes:
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>  - db.system: postgresql
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>  - db.operation.name: find
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>  - db.collection.name: users
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>  - db.query.filters_count: 1
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>  - db.query.limit: 10
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>  - db.result.count: 10
</code></pre></div></p>
<h4 id="count"><code>count()</code><a class="headerlink" href="#count" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">count</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>Name: db.query.count
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>Attributes:
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>  - db.system: postgresql
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>  - db.operation.name: count
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>  - db.collection.name: users
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>  - db.query.filters_count: 1
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>  - db.result.count: 42
</code></pre></div></p>
<h4 id="first"><code>first()</code><a class="headerlink" href="#first" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>Name: db.query.find
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>Attributes:
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>  - db.system: postgresql
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>  - db.operation.name: find
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>  - db.collection.name: users
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>  - db.query.filters_count: 1
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>  - db.query.limit: 1
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>  - db.result.count: 1
</code></pre></div></p>
<h4 id="exists"><code>exists()</code><a class="headerlink" href="#exists" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">exists</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>Name: db.query.exists
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>Attributes:
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>  - db.system: postgresql
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>  - db.operation.name: exists
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>  - db.collection.name: users
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>  - db.query.filters_count: 1
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>  - db.result.count: 1  # (0 or 1)
</code></pre></div></p>
<h4 id="aggregate"><code>aggregate()</code><a class="headerlink" href="#aggregate" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">([</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>    <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$country&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="p">])</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>Name: db.query.aggregate
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>Attributes:
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>  - db.system: postgresql
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>  - db.operation.name: aggregate
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>  - db.collection.name: users
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>  - db.result.count: 5  # Number of aggregation results
</code></pre></div></p>
<h3 id="sessions">Sessions<a class="headerlink" href="#sessions" title="Permanent link">&para;</a></h3>
<p>Session operations track transaction lifecycle and state changes.</p>
<h4 id="open-session-context-manager"><code>open()</code> / Session Context Manager<a class="headerlink" href="#open-session-context-manager" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">async</span> <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="s2">&quot;postgresql://localhost/mydb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>    <span class="c1"># Session operations</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>    <span class="k">pass</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>Name: db.session.open
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>Attributes:
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>  - db.system: postgresql
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>  - db.session.operation: open
</code></pre></div></p>
<p><strong>On exit</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>Name: db.session.close
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>Attributes:
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>  - db.system: postgresql
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>  - db.session.operation: close
</code></pre></div></p>
<h4 id="flush"><code>flush()</code><a class="headerlink" href="#flush" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">user1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">user2</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># Persist pending changes</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>Name: db.session.flush
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>Attributes:
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>  - db.system: postgresql
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>  - db.session.operation: flush
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>  - db.session.pending_count: 2  # New objects to insert
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>  - db.session.dirty_count: 0    # Modified objects
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>  - db.session.deleted_count: 0  # Objects to delete
</code></pre></div></p>
<h4 id="commit"><code>commit()</code><a class="headerlink" href="#commit" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">31</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Flush + commit transaction</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>Name: db.session.commit
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>Attributes:
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>  - db.system: postgresql
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>  - db.session.operation: commit
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>  - db.session.pending_count: 0
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>  - db.session.dirty_count: 1  # Modified object
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>  - db.session.deleted_count: 0
</code></pre></div></p>
<h4 id="rollback"><code>rollback()</code><a class="headerlink" href="#rollback" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>    <span class="n">user</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Invalid</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1"># Undo changes</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>Name: db.session.rollback
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>Attributes:
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>  - db.system: postgresql
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>  - db.session.operation: rollback
</code></pre></div></p>
<h3 id="relationships">Relationships<a class="headerlink" href="#relationships" title="Permanent link">&para;</a></h3>
<p>Relationship loading is automatically instrumented to help detect N+1 queries.</p>
<h4 id="lazy-loading-select-strategy">Lazy Loading (<code>select</code> strategy)<a class="headerlink" href="#lazy-loading-select-strategy" title="Permanent link">&para;</a></h4>
<p><strong>Individual load per access</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1"># Load user</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="c1"># Access relationship (triggers lazy load)</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user</span><span class="o">.</span><span class="n">posts</span>  <span class="c1"># Span created here</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>Name: db.relationship.select
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>Attributes:
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>  - db.system: postgresql
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>  - db.relationship.name: posts
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>  - db.relationship.target_model: Post
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>  - db.relationship.strategy: select
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>  - db.relationship.fk_column: author_id
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>  - db.relationship.cache_hit: false  # Not in session cache
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>  - db.result.count: 5  # 5 posts loaded
</code></pre></div></p>
<p><strong>Cache hit example</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">user1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="n">posts1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user1</span><span class="o">.</span><span class="n">posts</span>  <span class="c1"># Loads from database</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="c1"># Later in same session</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="n">user1_again</span> <span class="o">=</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># From identity map</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="n">posts1_again</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user1_again</span><span class="o">.</span><span class="n">posts</span>  <span class="c1"># From cache</span>
</code></pre></div>
<p><strong>Span created (cache hit)</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>Name: db.relationship.select
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>Attributes:
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>  - db.relationship.name: posts
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>  - db.relationship.cache_hit: true  # Served from cache!
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>  - db.result.count: 5
</code></pre></div></p>
<h4 id="eager-loading-selectinload-strategy">Eager Loading (<code>selectinload</code> strategy)<a class="headerlink" href="#eager-loading-selectinload-strategy" title="Permanent link">&para;</a></h4>
<p><strong>Batch load for multiple instances</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">selectinload</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="c1"># Load users with posts in one batch query</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>    <span class="n">selectinload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">posts</span><span class="p">)</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="c1"># Access posts - no query needed, already loaded</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>    <span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user</span><span class="o">.</span><span class="n">posts</span>  <span class="c1"># No span, already in memory</span>
</code></pre></div>
<p><strong>Span created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>Name: db.relationship.selectinload
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>Attributes:
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>  - db.system: postgresql
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>  - db.relationship.name: posts
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>  - db.relationship.target_model: Post
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>  - db.relationship.strategy: selectinload
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>  - db.relationship.fk_column: author_id
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>  - db.relationship.batch_count: 100  # Loaded for 100 users
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>  - db.result.count: 250  # 250 total posts loaded
</code></pre></div></p>
<p><strong>Depth tracking</strong> (nested eager loading):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>    <span class="n">selectinload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">posts</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>        <span class="n">selectinload</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>    <span class="p">)</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</code></pre></div>
<p><strong>Spans created</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>1. db.relationship.selectinload (posts)
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>   - db.relationship.depth: 0
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>   - db.relationship.batch_count: 100
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>2. db.relationship.selectinload (comments)
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>   - db.relationship.depth: 1  # Nested relationship
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>   - db.relationship.batch_count: 250
</code></pre></div></p>
<hr />
<h2 id="span-attributes-reference">Span Attributes Reference<a class="headerlink" href="#span-attributes-reference" title="Permanent link">&para;</a></h2>
<p>Complete reference of all span attributes used by data-bridge.</p>
<h3 id="standard-opentelemetry-attributes">Standard OpenTelemetry Attributes<a class="headerlink" href="#standard-opentelemetry-attributes" title="Permanent link">&para;</a></h3>
<p>Following <a href="https://opentelemetry.io/docs/specs/semconv/database/">OpenTelemetry Semantic Conventions for Database Calls</a>:</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>db.system</code></td>
<td>string</td>
<td>Database system (always "postgresql")</td>
<td><code>postgresql</code></td>
</tr>
<tr>
<td><code>db.operation.name</code></td>
<td>string</td>
<td>Operation type</td>
<td><code>find</code>, <code>insert</code>, <code>update</code>, <code>delete</code></td>
</tr>
<tr>
<td><code>db.collection.name</code></td>
<td>string</td>
<td>Table name</td>
<td><code>users</code>, <code>posts</code></td>
</tr>
<tr>
<td><code>db.statement</code></td>
<td>string</td>
<td>SQL statement (optional, use sparingly)</td>
<td><code>SELECT * FROM users WHERE age &gt; $1</code></td>
</tr>
</tbody>
</table>
<h3 id="query-attributes">Query Attributes<a class="headerlink" href="#query-attributes" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
<th>Example</th>
<th>Cardinality</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>db.query.filters_count</code></td>
<td>int</td>
<td>Number of WHERE conditions</td>
<td><code>3</code></td>
<td>Low (0-100)</td>
</tr>
<tr>
<td><code>db.query.limit</code></td>
<td>int</td>
<td>LIMIT clause value</td>
<td><code>10</code></td>
<td>Low (common values)</td>
</tr>
<tr>
<td><code>db.query.offset</code></td>
<td>int</td>
<td>OFFSET clause value</td>
<td><code>20</code></td>
<td>Medium (pagination)</td>
</tr>
<tr>
<td><code>db.query.order_by</code></td>
<td>string</td>
<td>ORDER BY clause</td>
<td><code>created_at DESC</code></td>
<td>Medium</td>
</tr>
</tbody>
</table>
<p><strong>Cardinality note</strong>: Avoid high-cardinality values (e.g., unique IDs) in attributes.</p>
<h3 id="result-attributes">Result Attributes<a class="headerlink" href="#result-attributes" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>db.result.count</code></td>
<td>int</td>
<td>Number of rows returned</td>
<td><code>42</code></td>
</tr>
<tr>
<td><code>db.result.affected_rows</code></td>
<td>int</td>
<td>Number of rows modified</td>
<td><code>5</code></td>
</tr>
</tbody>
</table>
<h3 id="session-attributes">Session Attributes<a class="headerlink" href="#session-attributes" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>db.session.operation</code></td>
<td>string</td>
<td>Session operation</td>
<td><code>flush</code>, <code>commit</code>, <code>rollback</code></td>
</tr>
<tr>
<td><code>db.session.pending_count</code></td>
<td>int</td>
<td>New objects to insert</td>
<td><code>3</code></td>
</tr>
<tr>
<td><code>db.session.dirty_count</code></td>
<td>int</td>
<td>Modified objects to update</td>
<td><code>2</code></td>
</tr>
<tr>
<td><code>db.session.deleted_count</code></td>
<td>int</td>
<td>Objects to delete</td>
<td><code>1</code></td>
</tr>
</tbody>
</table>
<h3 id="relationship-attributes">Relationship Attributes<a class="headerlink" href="#relationship-attributes" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>db.relationship.name</code></td>
<td>string</td>
<td>Relationship attribute name</td>
<td><code>posts</code>, <code>author</code></td>
</tr>
<tr>
<td><code>db.relationship.target_model</code></td>
<td>string</td>
<td>Target model class name</td>
<td><code>Post</code>, <code>User</code></td>
</tr>
<tr>
<td><code>db.relationship.strategy</code></td>
<td>string</td>
<td>Loading strategy</td>
<td><code>select</code>, <code>selectinload</code>, <code>joined</code></td>
</tr>
<tr>
<td><code>db.relationship.fk_column</code></td>
<td>string</td>
<td>Foreign key column</td>
<td><code>author_id</code></td>
</tr>
<tr>
<td><code>db.relationship.cache_hit</code></td>
<td>bool</td>
<td>Loaded from session cache</td>
<td><code>true</code>, <code>false</code></td>
</tr>
<tr>
<td><code>db.relationship.batch_count</code></td>
<td>int</td>
<td>Instances in batch load (eager only)</td>
<td><code>100</code></td>
</tr>
<tr>
<td><code>db.relationship.depth</code></td>
<td>int</td>
<td>Nesting level (0 = top-level)</td>
<td><code>0</code>, <code>1</code>, <code>2</code></td>
</tr>
</tbody>
</table>
<h3 id="error-attributes">Error Attributes<a class="headerlink" href="#error-attributes" title="Permanent link">&para;</a></h3>
<p>When exceptions occur, spans automatically include:</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>exception.type</code></td>
<td>string</td>
<td>Exception class name</td>
</tr>
<tr>
<td><code>exception.message</code></td>
<td>string</td>
<td>Exception message</td>
</tr>
<tr>
<td><code>exception.stacktrace</code></td>
<td>string</td>
<td>Full stack trace</td>
</tr>
<tr>
<td><code>otel.status_code</code></td>
<td>string</td>
<td><code>ERROR</code> when exception occurs</td>
</tr>
</tbody>
</table>
<h3 id="complete-example-span">Complete Example Span<a class="headerlink" href="#complete-example-span" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="p">{</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">  </span><span class="nt">&quot;trace_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6&quot;</span><span class="p">,</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">  </span><span class="nt">&quot;span_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;q7r8s9t0u1v2&quot;</span><span class="p">,</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">  </span><span class="nt">&quot;parent_span_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;w3x4y5z6a7b8&quot;</span><span class="p">,</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;db.query.find&quot;</span><span class="p">,</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">  </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INTERNAL&quot;</span><span class="p">,</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">  </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-01-06T10:30:00.123Z&quot;</span><span class="p">,</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">  </span><span class="nt">&quot;end_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-01-06T10:30:00.145Z&quot;</span><span class="p">,</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">  </span><span class="nt">&quot;duration_ms&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">  </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">    </span><span class="nt">&quot;db.system&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgresql&quot;</span><span class="p">,</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">    </span><span class="nt">&quot;db.operation.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;find&quot;</span><span class="p">,</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">    </span><span class="nt">&quot;db.collection.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;users&quot;</span><span class="p">,</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="w">    </span><span class="nt">&quot;db.query.filters_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="w">    </span><span class="nt">&quot;db.query.limit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="w">    </span><span class="nt">&quot;db.query.offset&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="w">    </span><span class="nt">&quot;db.query.order_by&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;created_at DESC&quot;</span><span class="p">,</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="w">    </span><span class="nt">&quot;db.result.count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a><span class="w">    </span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OK&quot;</span>
<a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a><span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="otlp-backends">OTLP Backends<a class="headerlink" href="#otlp-backends" title="Permanent link">&para;</a></h2>
<p>data-bridge supports any OpenTelemetry-compatible backend via OTLP (OpenTelemetry Protocol).</p>
<h3 id="jaeger-local-development">Jaeger (Local Development)<a class="headerlink" href="#jaeger-local-development" title="Permanent link">&para;</a></h3>
<p><strong>Best for</strong>: Local development, testing traces</p>
<p><strong>Setup</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--name<span class="w"> </span>jaeger<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">  </span>-e<span class="w"> </span><span class="nv">COLLECTOR_OTLP_ENABLED</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">  </span>-p<span class="w"> </span><span class="m">16686</span>:16686<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">  </span>-p<span class="w"> </span><span class="m">4317</span>:4317<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">  </span>-p<span class="w"> </span><span class="m">4318</span>:4318<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">  </span>jaegertracing/all-in-one:latest
</code></pre></div></p>
<p><strong>Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_ENDPOINT</span><span class="o">=</span>http://localhost:4317
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_INSECURE</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></p>
<p><strong>Python</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;http://localhost:4317&quot;</span><span class="p">,</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>View traces</strong>: http://localhost:16686</p>
<hr />
<h3 id="grafana-cloud-saas">Grafana Cloud (SaaS)<a class="headerlink" href="#grafana-cloud-saas" title="Permanent link">&para;</a></h3>
<p><strong>Best for</strong>: Production, integrated observability stack</p>
<p><strong>Setup</strong>:
1. Sign up at https://grafana.com/
2. Get credentials from: Connections → OpenTelemetry → Send Traces
3. Format: <code>instance_id:api_token</code></p>
<p><strong>Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># Encode credentials</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="nv">CREDENTIALS</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;instance_id:api_token&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="k">)</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_ENDPOINT</span><span class="o">=</span>https://otlp-gateway-prod-us-central-0.grafana.net/otlp
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_INSECURE</span><span class="o">=</span><span class="nb">false</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_HEADERS</span><span class="o">=</span><span class="s2">&quot;Authorization=Basic </span><span class="si">${</span><span class="nv">CREDENTIALS</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></p>
<p><strong>Python</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="n">credentials</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;instance_id:api_token&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;https://otlp-gateway-prod-us-central-0.grafana.net/otlp&quot;</span><span class="p">,</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Basic </span><span class="si">{</span><span class="n">credentials</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>View traces</strong>: Your Grafana instance → Explore → Tempo</p>
<hr />
<h3 id="datadog-apm">DataDog APM<a class="headerlink" href="#datadog-apm" title="Permanent link">&para;</a></h3>
<p><strong>Best for</strong>: Production APM, full observability suite</p>
<p><strong>Setup</strong>:
1. Get API key from: https://app.datadoghq.com/organization-settings/api-keys
2. Install DataDog agent with OTLP support</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--name<span class="w"> </span>datadog-agent<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">  </span>-e<span class="w"> </span><span class="nv">DD_API_KEY</span><span class="o">=</span>&lt;your-api-key&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">  </span>-e<span class="w"> </span><span class="nv">DD_SITE</span><span class="o">=</span>datadoghq.com<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">  </span>-e<span class="w"> </span><span class="nv">DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_GRPC_ENDPOINT</span><span class="o">=</span><span class="m">0</span>.0.0.0:4317<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">  </span>-p<span class="w"> </span><span class="m">4317</span>:4317<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">  </span>gcr.io/datadoghq/agent:latest
</code></pre></div>
<p><strong>Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_ENDPOINT</span><span class="o">=</span>http://localhost:4317
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_INSECURE</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DD_SERVICE</span><span class="o">=</span>my-api
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DD_ENV</span><span class="o">=</span>production
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DD_VERSION</span><span class="o">=</span><span class="m">1</span>.0.0
</code></pre></div></p>
<p><strong>Python</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;http://localhost:4317&quot;</span><span class="p">,</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="p">)</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="c1"># Add DataDog-specific resource attributes</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>    <span class="s2">&quot;service.name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-api&quot;</span><span class="p">,</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>    <span class="s2">&quot;deployment.environment&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>    <span class="s2">&quot;service.version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="p">})</span>
</code></pre></div></p>
<p><strong>View traces</strong>: https://app.datadoghq.com/apm/traces</p>
<hr />
<h3 id="new-relic">New Relic<a class="headerlink" href="#new-relic" title="Permanent link">&para;</a></h3>
<p><strong>Best for</strong>: Production APM, alerting</p>
<p><strong>Setup</strong>:
1. Get license key from: https://one.newrelic.com/api-keys</p>
<p><strong>Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_ENDPOINT</span><span class="o">=</span>https://otlp.nr-data.net:4317
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_INSECURE</span><span class="o">=</span><span class="nb">false</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_HEADERS</span><span class="o">=</span><span class="s2">&quot;api-key=&lt;your-license-key&gt;&quot;</span>
</code></pre></div></p>
<p><strong>Python</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;https://otlp.nr-data.net:4317&quot;</span><span class="p">,</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;api-key&quot;</span><span class="p">:</span> <span class="s2">&quot;your-license-key&quot;</span><span class="p">},</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>View traces</strong>: https://one.newrelic.com/distributed-tracing</p>
<hr />
<h3 id="honeycombio">Honeycomb.io<a class="headerlink" href="#honeycombio" title="Permanent link">&para;</a></h3>
<p><strong>Best for</strong>: Deep trace analysis, query-based exploration</p>
<p><strong>Setup</strong>:
1. Get API key from: https://ui.honeycomb.io/account</p>
<p><strong>Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_ENDPOINT</span><span class="o">=</span>https://api.honeycomb.io:443
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_INSECURE</span><span class="o">=</span><span class="nb">false</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_HEADERS</span><span class="o">=</span><span class="s2">&quot;x-honeycomb-team=&lt;your-api-key&gt;&quot;</span>
</code></pre></div></p>
<p><strong>Python</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;https://api.honeycomb.io:443&quot;</span><span class="p">,</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x-honeycomb-team&quot;</span><span class="p">:</span> <span class="s2">&quot;your-api-key&quot;</span><span class="p">},</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="p">)</span>
</code></pre></div></p>
<p><strong>View traces</strong>: https://ui.honeycomb.io/</p>
<hr />
<h3 id="aws-x-ray-via-adot-collector">AWS X-Ray (via ADOT Collector)<a class="headerlink" href="#aws-x-ray-via-adot-collector" title="Permanent link">&para;</a></h3>
<p><strong>Best for</strong>: AWS environments, integrated AWS observability</p>
<p><strong>Setup</strong>:
1. Deploy AWS Distro for OpenTelemetry (ADOT) collector
2. Configure collector to export to X-Ray</p>
<p><strong>Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_ENDPOINT</span><span class="o">=</span>http://localhost:4317
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_INSECURE</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_REGION</span><span class="o">=</span>us-east-1
</code></pre></div></p>
<p><strong>Python</strong>: Same as Jaeger (ADOT collector handles X-Ray export)</p>
<p><strong>View traces</strong>: AWS Console → X-Ray → Traces</p>
<hr />
<h3 id="environment-variable-template">Environment Variable Template<a class="headerlink" href="#environment-variable-template" title="Permanent link">&para;</a></h3>
<p>Copy this to your <code>.env</code> file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="c1"># Service identification</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="nv">SERVICE_NAME</span><span class="o">=</span>my-api
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="nv">SERVICE_VERSION</span><span class="o">=</span><span class="m">1</span>.0.0
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="nv">DEPLOYMENT_ENVIRONMENT</span><span class="o">=</span>production
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="c1"># OTLP configuration (choose one backend)</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="nv">OTEL_EXPORTER_OTLP_ENDPOINT</span><span class="o">=</span>http://localhost:4317
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="nv">OTEL_EXPORTER_OTLP_INSECURE</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="c1"># OTEL_EXPORTER_OTLP_HEADERS=api-key=your-key-here</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="c1"># data-bridge tracing</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="nv">DATA_BRIDGE_TRACING_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="c1"># Sampling (optional)</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="nv">OTEL_TRACES_SAMPLER</span><span class="o">=</span>traceidratio
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a><span class="nv">OTEL_TRACES_SAMPLER_ARG</span><span class="o">=</span><span class="m">0</span>.1<span class="w">  </span><span class="c1"># 10% sampling</span>
</code></pre></div>
<hr />
<h2 id="performance-considerations">Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permanent link">&para;</a></h2>
<h3 id="overhead-when-enabled-vs-disabled">Overhead When Enabled vs Disabled<a class="headerlink" href="#overhead-when-enabled-vs-disabled" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Overhead</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Tracing disabled</strong></td>
<td><strong>0ms</strong></td>
<td>Fast-path check, no span creation</td>
</tr>
<tr>
<td><strong>Tracing enabled, no export</strong></td>
<td>~0.5ms per span</td>
<td>Span creation only</td>
</tr>
<tr>
<td><strong>Tracing enabled, with export</strong></td>
<td>~1-2ms per span</td>
<td>Includes serialization + async export</td>
</tr>
<tr>
<td><strong>Batch export</strong></td>
<td>Amortized &lt;0.5ms</td>
<td>Export every 5s or 512 spans</td>
</tr>
</tbody>
</table>
<p><strong>Key insight</strong>: When <code>DATA_BRIDGE_TRACING_ENABLED=false</code>, there is <strong>zero overhead</strong> due to fast-path optimization:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_query_span</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>    <span class="c1"># Fast path: immediate return if disabled</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>    <span class="n">tracer</span> <span class="o">=</span> <span class="n">get_tracer</span><span class="p">()</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>    <span class="k">if</span> <span class="n">tracer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>        <span class="k">yield</span> <span class="kc">None</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>        <span class="k">return</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>    <span class="c1"># Instrumented path only runs if tracing enabled</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>    <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>        <span class="k">yield</span> <span class="n">span</span>
</code></pre></div>
<h3 id="sampling-strategies">Sampling Strategies<a class="headerlink" href="#sampling-strategies" title="Permanent link">&para;</a></h3>
<p><strong>Recommendation by traffic volume</strong>:</p>
<table>
<thead>
<tr>
<th>Traffic</th>
<th>Sampling Rate</th>
<th>Config</th>
</tr>
</thead>
<tbody>
<tr>
<td>Development</td>
<td>100%</td>
<td><code>ALWAYS_ON</code></td>
</tr>
<tr>
<td>&lt;100 req/min</td>
<td>100%</td>
<td><code>TraceIdRatioBased(1.0)</code></td>
</tr>
<tr>
<td>&lt;1000 req/min</td>
<td>50%</td>
<td><code>TraceIdRatioBased(0.5)</code></td>
</tr>
<tr>
<td>&lt;10k req/min</td>
<td>10%</td>
<td><code>TraceIdRatioBased(0.1)</code></td>
</tr>
<tr>
<td>10k+ req/min</td>
<td>1-5%</td>
<td><code>TraceIdRatioBased(0.01)</code></td>
</tr>
</tbody>
</table>
<p><strong>Head-based vs Tail-based sampling</strong>:</p>
<ul>
<li><strong>Head-based</strong> (used by data-bridge): Decision made at trace creation</li>
<li>Pros: Low overhead, simple configuration</li>
<li>
<p>Cons: May miss interesting traces (e.g., errors)</p>
</li>
<li>
<p><strong>Tail-based</strong> (requires collector): Decision after trace completes</p>
</li>
<li>Pros: Can sample based on duration, errors, attributes</li>
<li>Cons: Higher overhead, complex setup</li>
</ul>
<p><strong>Recommendation</strong>: Start with head-based sampling, add tail-based for advanced use cases.</p>
<h3 id="batch-exporting-configuration">Batch Exporting Configuration<a class="headerlink" href="#batch-exporting-configuration" title="Permanent link">&para;</a></h3>
<p>Optimize span export to reduce network overhead:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchSpanProcessor</span><span class="p">(</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>    <span class="n">exporter</span><span class="p">,</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>    <span class="c1"># Export every 5 seconds (balance latency vs overhead)</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="n">schedule_delay_millis</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>    <span class="c1"># Or when 512 spans collected (reduce network calls)</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>    <span class="n">max_export_batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>    <span class="c1"># Max queue size (prevent memory issues)</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>    <span class="n">max_queue_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="p">)</span>
</code></pre></div>
<p><strong>Impact</strong>:</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Network Calls/sec</th>
<th>Memory Usage</th>
<th>Latency</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>schedule_delay_millis=1000</code></td>
<td>1/sec</td>
<td>Low</td>
<td>1s</td>
</tr>
<tr>
<td><code>schedule_delay_millis=5000</code></td>
<td>0.2/sec</td>
<td>Medium</td>
<td>5s</td>
</tr>
<tr>
<td><code>schedule_delay_millis=10000</code></td>
<td>0.1/sec</td>
<td>Higher</td>
<td>10s</td>
</tr>
<tr>
<td><code>max_export_batch_size=512</code></td>
<td>Variable</td>
<td>Low</td>
<td>Variable</td>
</tr>
</tbody>
</table>
<p><strong>Production recommendation</strong>:
- <code>schedule_delay_millis</code>: 5000 (5 seconds)
- <code>max_export_batch_size</code>: 512
- <code>max_queue_size</code>: 2048</p>
<h3 id="fast-path-optimization">Fast-Path Optimization<a class="headerlink" href="#fast-path-optimization" title="Permanent link">&para;</a></h3>
<p>data-bridge uses fast-path checks to minimize overhead when tracing is disabled:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="c1"># Before any span logic</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">is_tracing_enabled</span><span class="p">():</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>    <span class="c1"># Original logic without instrumentation</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">_execute_query</span><span class="p">()</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="c1"># Instrumented path (only if tracing enabled)</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_execute_query</span><span class="p">()</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>    <span class="n">set_span_result</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<p><strong>Benchmark</strong>:</p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Query latency</th>
<th>Overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td>No telemetry code</td>
<td>10.0ms</td>
<td>-</td>
</tr>
<tr>
<td>Telemetry disabled</td>
<td>10.0ms</td>
<td>0ms</td>
</tr>
<tr>
<td>Telemetry enabled</td>
<td>11.5ms</td>
<td>1.5ms</td>
</tr>
</tbody>
</table>
<h3 id="cardinality-considerations">Cardinality Considerations<a class="headerlink" href="#cardinality-considerations" title="Permanent link">&para;</a></h3>
<p><strong>Low-cardinality span names</strong> (good):
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c1"># Span name: db.query.find (low cardinality)</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="p">):</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>    <span class="o">...</span>
</code></pre></div></p>
<p><strong>High-cardinality span names</strong> (bad):
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1"># DON&#39;T: Include unique values in span names</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="n">span_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;db.query.find.user.</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># ❌ High cardinality</span>
</code></pre></div></p>
<p><strong>High-cardinality attributes</strong>:</p>
<p>Use attributes for unique values, but be aware of limits:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="c1"># OK: Attributes can have high cardinality</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>  <span class="c1"># ✅ OK in attributes</span>
</code></pre></div>
<p><strong>Limits</strong>:
- Default attribute value length: 4096 characters
- Default attribute count: 128 per span</p>
<p>Configure limits:
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT</span><span class="o">=</span><span class="m">4096</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT</span><span class="o">=</span><span class="m">128</span>
</code></pre></div></p>
<hr />
<h2 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h2>
<h3 id="development-vs-production-configuration">Development vs Production Configuration<a class="headerlink" href="#development-vs-production-configuration" title="Permanent link">&para;</a></h3>
<p><strong>Development</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># Simple console exporter</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConsoleSpanExporter</span><span class="p">,</span> <span class="n">SimpleSpanProcessor</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">()</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">SimpleSpanProcessor</span><span class="p">(</span><span class="n">ConsoleSpanExporter</span><span class="p">()))</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="c1"># Or use Jaeger locally</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;http://localhost:4317&quot;</span><span class="p">,</span> <span class="n">insecure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">BatchSpanProcessor</span><span class="p">(</span><span class="n">exporter</span><span class="p">))</span>
</code></pre></div></p>
<p><strong>Production</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1"># OTLP exporter with sampling and batching</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParentBased</span><span class="p">,</span> <span class="n">TraceIdRatioBased</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>    <span class="s2">&quot;service.name&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SERVICE_NAME&quot;</span><span class="p">),</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>    <span class="s2">&quot;service.version&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SERVICE_VERSION&quot;</span><span class="p">),</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>    <span class="s2">&quot;deployment.environment&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="p">})</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="n">sampler</span> <span class="o">=</span> <span class="n">ParentBased</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">TraceIdRatioBased</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>  <span class="c1"># 10% sampling</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">)</span>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>    <span class="n">endpoint</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OTEL_EXPORTER_OTLP_ENDPOINT&quot;</span><span class="p">),</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a>    <span class="n">insecure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Use TLS</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="p">)</span>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchSpanProcessor</span><span class="p">(</span>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a>    <span class="n">exporter</span><span class="p">,</span>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a>    <span class="n">schedule_delay_millis</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a>    <span class="n">max_export_batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="p">)</span>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a>
<a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
<a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="sampling-rates">Sampling Rates<a class="headerlink" href="#sampling-rates" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Environment</th>
<th>Rate</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td>Development</td>
<td>100%</td>
<td>See all traces</td>
</tr>
<tr>
<td>Staging</td>
<td>50%</td>
<td>Balance cost and coverage</td>
</tr>
<tr>
<td>Production (low traffic)</td>
<td>100%</td>
<td>Full visibility</td>
</tr>
<tr>
<td>Production (high traffic)</td>
<td>10%</td>
<td>Reduce overhead and cost</td>
</tr>
<tr>
<td>Production (very high)</td>
<td>1%</td>
<td>Minimize impact</td>
</tr>
</tbody>
</table>
<p><strong>Adjust based on</strong>:
- Traffic volume
- Backend costs (some charge per span)
- Performance requirements
- Debugging needs</p>
<h3 id="resource-attribute-naming">Resource Attribute Naming<a class="headerlink" href="#resource-attribute-naming" title="Permanent link">&para;</a></h3>
<p><strong>Good practices</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>    <span class="c1"># Standard attributes (follow semantic conventions)</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>    <span class="s2">&quot;service.name&quot;</span><span class="p">:</span> <span class="s2">&quot;user-api&quot;</span><span class="p">,</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>    <span class="s2">&quot;service.version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.3.1&quot;</span><span class="p">,</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>    <span class="s2">&quot;deployment.environment&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>    <span class="c1"># Namespace custom attributes</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>    <span class="s2">&quot;app.team&quot;</span><span class="p">:</span> <span class="s2">&quot;backend&quot;</span><span class="p">,</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>    <span class="s2">&quot;app.feature.flags&quot;</span><span class="p">:</span> <span class="s2">&quot;feature-x&quot;</span><span class="p">,</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>    <span class="c1"># Use lowercase with dots</span>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>    <span class="s2">&quot;db.connection.pool.size&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a><span class="p">})</span>
</code></pre></div>
<p><strong>Avoid</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="c1"># ❌ Bad: Inconsistent naming</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="s2">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;user-api&quot;</span>  <span class="c1"># Use lowercase</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="s2">&quot;team_name&quot;</span><span class="p">:</span> <span class="s2">&quot;backend&quot;</span>     <span class="c1"># Use dots, not underscores</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="s2">&quot;feature_x_enabled&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>  <span class="c1"># No namespace</span>
</code></pre></div></p>
<h3 id="span-attribute-limits">Span Attribute Limits<a class="headerlink" href="#span-attribute-limits" title="Permanent link">&para;</a></h3>
<p><strong>Default limits</strong>:
- Attribute value length: 4096 characters
- Attribute count: 128 per span
- Event count: 128 per span</p>
<p><strong>Configure</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT</span><span class="o">=</span><span class="m">4096</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT</span><span class="o">=</span><span class="m">128</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_SPAN_EVENT_COUNT_LIMIT</span><span class="o">=</span><span class="m">128</span>
</code></pre></div></p>
<p><strong>Best practices</strong>:
- Don't include large payloads in attributes (e.g., full request bodies)
- Truncate long strings (e.g., SQL statements)
- Use events for detailed information</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>    <span class="c1"># ✅ Good: Short, meaningful attributes</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user.role&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">)</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>    <span class="c1"># ❌ Bad: Large payload</span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>    <span class="c1"># span.set_attribute(&quot;request.body&quot;, json.dumps(large_dict))</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>    <span class="c1"># ✅ Better: Use events for details</span>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>    <span class="n">span</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s2">&quot;query_details&quot;</span><span class="p">,</span> <span class="p">{</span>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>        <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">filters</span><span class="p">)[:</span><span class="mi">100</span><span class="p">],</span>  <span class="c1"># Truncate</span>
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>    <span class="p">})</span>
</code></pre></div></p>
<h3 id="security-considerations-pii-in-spans">Security Considerations (PII in Spans)<a class="headerlink" href="#security-considerations-pii-in-spans" title="Permanent link">&para;</a></h3>
<p><strong>Never include</strong>:
- Passwords
- Credit card numbers
- Social security numbers
- API keys/tokens
- Personal identifiable information (PII)</p>
<p><strong>Avoid including</strong>:
- Email addresses (use hashed IDs instead)
- Full names (use user IDs)
- Phone numbers
- IP addresses (unless necessary)</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># ❌ Bad: Includes PII</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user.email&quot;</span><span class="p">,</span> <span class="s2">&quot;alice@example.com&quot;</span><span class="p">)</span>  <span class="c1"># PII</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user.password&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>  <span class="c1"># Never!</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="c1"># ✅ Good: Use IDs instead</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a>    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">,</span> <span class="mi">12345</span><span class="p">)</span>  <span class="c1"># Safe</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user.role&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">)</span>  <span class="c1"># Safe</span>
</code></pre></div></p>
<p><strong>SQL statement sanitization</strong>:</p>
<p>data-bridge uses parameterized queries, so SQL statements in spans are safe:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1"># Safe: Parameters not included</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="n">db</span><span class="o">.</span><span class="n">statement</span><span class="p">:</span> <span class="s2">&quot;SELECT * FROM users WHERE email = $1&quot;</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="c1"># $1 is a placeholder, actual email not exposed</span>
</code></pre></div>
<p><strong>Disable statement logging</strong> (if needed):
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="c1"># Don&#39;t set db.statement attribute</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="p">):</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>    <span class="c1"># statement parameter omitted</span>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>    <span class="o">...</span>
</code></pre></div></p>
<h3 id="graceful-degradation">Graceful Degradation<a class="headerlink" href="#graceful-degradation" title="Permanent link">&para;</a></h3>
<p>data-bridge handles missing OpenTelemetry SDK gracefully:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1"># Without OpenTelemetry SDK installed</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">User</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="s2">&quot;postgresql://localhost/mydb&quot;</span><span class="p">)</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>  <span class="c1"># Works fine, no tracing</span>
</code></pre></div>
<p><strong>No errors, no crashes</strong> - telemetry is optional!</p>
<p><strong>Check availability</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">OTEL_AVAILABLE</span><span class="p">,</span> <span class="n">is_tracing_enabled</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="k">if</span> <span class="n">OTEL_AVAILABLE</span><span class="p">:</span>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenTelemetry SDK installed&quot;</span><span class="p">)</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenTelemetry SDK not available (install opentelemetry-sdk)&quot;</span><span class="p">)</span>
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="k">if</span> <span class="n">is_tracing_enabled</span><span class="p">():</span>
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing is active&quot;</span><span class="p">)</span>
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing is disabled&quot;</span><span class="p">)</span>
</code></pre></div></p>
<hr />
<h2 id="n1-query-detection">N+1 Query Detection<a class="headerlink" href="#n1-query-detection" title="Permanent link">&para;</a></h2>
<h3 id="how-to-identify-n1-queries-in-traces">How to Identify N+1 Queries in Traces<a class="headerlink" href="#how-to-identify-n1-queries-in-traces" title="Permanent link">&para;</a></h3>
<p><strong>N+1 pattern</strong>: 1 query to fetch parent records + N queries to fetch related records</p>
<p><strong>Example trace (N+1 problem)</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>GET /posts
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>├─ db.query.find (posts) [1 query]
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>│  └─ db.result.count: 10
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>│
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>├─ db.relationship.select (author) [Query 1]
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>│  └─ db.relationship.cache_hit: false
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>│
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>├─ db.relationship.select (author) [Query 2]
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>│  └─ db.relationship.cache_hit: false
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>│
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>├─ db.relationship.select (author) [Query 3]
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>│  └─ db.relationship.cache_hit: false
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>│
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a>... (7 more relationship spans)
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>│
<a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>└─ db.relationship.select (author) [Query 10]
<a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a>   └─ db.relationship.cache_hit: false
<a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>
<a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a>Total: 11 queries (1 + 10)
</code></pre></div>
<p><strong>Indicators of N+1</strong>:
1. Multiple <code>db.relationship.select</code> spans with same name
2. <code>db.relationship.cache_hit: false</code> for each
3. Number of relationship spans ≈ number of parent records</p>
<h3 id="using-span-counts-to-detect-patterns">Using Span Counts to Detect Patterns<a class="headerlink" href="#using-span-counts-to-detect-patterns" title="Permanent link">&para;</a></h3>
<p><strong>In Jaeger UI</strong>:</p>
<ol>
<li>Search for traces with high span counts:</li>
<li>Filter: <code>min_spans &gt; 10</code></li>
<li>
<p>Look for repeated span names</p>
</li>
<li>
<p>Check relationship spans:</p>
</li>
<li>Count <code>db.relationship.select</code> spans</li>
<li>If count = parent record count → N+1 pattern</li>
</ol>
<p><strong>Programmatic detection</strong> (custom span processor):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">N1Detector</span><span class="p">:</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>        <span class="c1"># Count relationship spans</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>        <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;db.relationship.select&quot;</span><span class="p">:</span>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>            <span class="n">relationship_name</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db.relationship.name&quot;</span><span class="p">)</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>            <span class="n">cache_hit</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db.relationship.cache_hit&quot;</span><span class="p">)</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_hit</span><span class="p">:</span>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>                <span class="c1"># Log potential N+1</span>
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential N+1: </span><span class="si">{</span><span class="n">relationship_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="eager-loading-as-solution">Eager Loading as Solution<a class="headerlink" href="#eager-loading-as-solution" title="Permanent link">&para;</a></h3>
<p><strong>Before (N+1)</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># Lazy loading: 1 + N queries</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>  <span class="c1"># 1 query</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>    <span class="n">author</span> <span class="o">=</span> <span class="k">await</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span>  <span class="c1"># N queries (1 per post)</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Post by </span><span class="si">{</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Trace</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>db.query.find (posts)
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>├─ db.relationship.select (author) × N times
</code></pre></div></p>
<p><strong>After (Eager loading)</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">selectinload</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="c1"># Eager loading: 2 queries total</span>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>    <span class="n">selectinload</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
<a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>    <span class="n">author</span> <span class="o">=</span> <span class="k">await</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span>  <span class="c1"># Already loaded, no query</span>
<a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Post by </span><span class="si">{</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Trace</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>db.query.find (posts)
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>└─ db.relationship.selectinload (author) × 1 time
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>   └─ db.relationship.batch_count: 10
</code></pre></div></p>
<h3 id="beforeafter-trace-examples">Before/After Trace Examples<a class="headerlink" href="#beforeafter-trace-examples" title="Permanent link">&para;</a></h3>
<p><strong>Before (N+1 with 10 posts)</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>Trace: GET /posts
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a>Duration: 120ms
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a>Spans: 12
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a>
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>db.query.find (posts)               [10ms]
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a>├─ db.result.count: 10
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a>│
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a>db.relationship.select (author #1)  [10ms]
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a>db.relationship.select (author #2)  [10ms]
<a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a>db.relationship.select (author #3)  [11ms]
<a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a>db.relationship.select (author #4)  [10ms]
<a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a>db.relationship.select (author #5)  [11ms]
<a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a>db.relationship.select (author #6)  [10ms]
<a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a>db.relationship.select (author #7)  [10ms]
<a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a>db.relationship.select (author #8)  [11ms]
<a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a>db.relationship.select (author #9)  [10ms]
<a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a>db.relationship.select (author #10) [10ms]
<a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a>
<a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a>Total: 11 database queries
<a id="__codelineno-85-20" name="__codelineno-85-20" href="#__codelineno-85-20"></a>Duration: 120ms
</code></pre></div>
<p><strong>After (Eager loading with selectinload)</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>Trace: GET /posts
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>Duration: 25ms
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a>Spans: 3
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a>db.query.find (posts)               [12ms]
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a>├─ db.result.count: 10
<a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a>│
<a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a>db.relationship.selectinload (author)  [10ms]
<a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a>├─ db.relationship.batch_count: 10
<a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a>└─ db.result.count: 5  # 5 unique authors
<a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>
<a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a>Total: 2 database queries
<a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a>Duration: 25ms
<a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a>Improvement: 4.8x faster, 5.5x fewer queries
</code></pre></div>
<p><strong>Key improvements</strong>:
- Queries: 11 → 2 (5.5x reduction)
- Duration: 120ms → 25ms (4.8x faster)
- Spans: 12 → 3 (4x fewer)</p>
<h3 id="automatic-n1-detection-future">Automatic N+1 Detection (Future)<a class="headerlink" href="#automatic-n1-detection-future" title="Permanent link">&para;</a></h3>
<p><strong>Planned feature</strong>: Emit warning spans when N+1 threshold exceeded</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="c1"># Future: Automatic detection</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>    <span class="n">author</span> <span class="o">=</span> <span class="k">await</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span>  <span class="c1"># After N accesses, warning span emitted</span>
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="c1"># Warning span:</span>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="c1"># Name: db.n1_warning</span>
<a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="c1"># Attributes:</span>
<a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a><span class="c1">#   - db.relationship.name: author</span>
<a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a><span class="c1">#   - db.n1.query_count: 10</span>
<a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a><span class="c1">#   - db.n1.recommendation: &quot;Use selectinload(Post.author)&quot;</span>
</code></pre></div>
<hr />
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<h3 id="common-issues-and-solutions">Common Issues and Solutions<a class="headerlink" href="#common-issues-and-solutions" title="Permanent link">&para;</a></h3>
<h4 id="issue-no-traces-appearing-in-backend">Issue: "No traces appearing in backend"<a class="headerlink" href="#issue-no-traces-appearing-in-backend" title="Permanent link">&para;</a></h4>
<p><strong>Symptoms</strong>:
- Application runs fine
- No traces in Jaeger/Grafana/etc.</p>
<p><strong>Debugging steps</strong>:</p>
<ol>
<li><strong>Check if OpenTelemetry SDK is installed</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">OTEL_AVAILABLE</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenTelemetry available: </span><span class="si">{</span><span class="n">OTEL_AVAILABLE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></li>
</ol>
<p>If <code>False</code>: Install SDK
   <div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>pip<span class="w"> </span>install<span class="w"> </span>opentelemetry-api<span class="w"> </span>opentelemetry-sdk
</code></pre></div></p>
<ol>
<li><strong>Check if tracing is enabled</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_tracing_enabled</span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracing enabled: </span><span class="si">{</span><span class="n">is_tracing_enabled</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></li>
</ol>
<p>If <code>False</code>: Enable tracing
   <div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DATA_BRIDGE_TRACING_ENABLED</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></p>
<ol>
<li><strong>Verify tracer provider is set</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_tracer_provider</span><span class="p">()</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracer provider: </span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></li>
</ol>
<p>If <code>&lt;class 'opentelemetry.trace.NoOpTracerProvider'&gt;</code>: Set up tracer provider
   <div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracerProvider</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">TracerProvider</span><span class="p">())</span>
</code></pre></div></p>
<ol>
<li><strong>Check span processor is configured</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_tracer_provider</span><span class="p">()</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Span processors: </span><span class="si">{</span><span class="n">provider</span><span class="o">.</span><span class="n">_active_span_processor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></li>
</ol>
<p>If empty: Add span processor
   <div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchSpanProcessor</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">BatchSpanProcessor</span><span class="p">(</span><span class="n">exporter</span><span class="p">))</span>
</code></pre></div></p>
<h4 id="issue-connection-errors-to-otlp-collector">Issue: "Connection errors to OTLP collector"<a class="headerlink" href="#issue-connection-errors-to-otlp-collector" title="Permanent link">&para;</a></h4>
<p><strong>Symptoms</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>ERROR: Failed to export spans to http://localhost:4317
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a>ConnectionError: [Errno 111] Connection refused
</code></pre></div></p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p><strong>Check collector is running</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1"># For Jaeger</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a>docker<span class="w"> </span>ps<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>jaeger
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="c1"># If not running</span>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a>docker<span class="w"> </span>start<span class="w"> </span>jaeger
</code></pre></div></p>
</li>
<li>
<p><strong>Verify endpoint</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$OTEL_EXPORTER_OTLP_ENDPOINT</span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="c1"># Should match collector address</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Check port</strong>:</p>
</li>
<li>gRPC: 4317 (default)</li>
<li>HTTP: 4318</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="c1"># Test connection</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a>nc<span class="w"> </span>-zv<span class="w"> </span>localhost<span class="w"> </span><span class="m">4317</span>
</code></pre></div>
<ol>
<li><strong>Check firewall/network</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="c1"># In Docker network</span>
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a>docker<span class="w"> </span>network<span class="w"> </span>inspect<span class="w"> </span>bridge
</code></pre></div></li>
</ol>
<h4 id="issue-performance-degradation">Issue: "Performance degradation"<a class="headerlink" href="#issue-performance-degradation" title="Permanent link">&para;</a></h4>
<p><strong>Symptoms</strong>:
- Application slower than expected
- High CPU usage</p>
<p><strong>Debugging</strong>:</p>
<ol>
<li><strong>Check sampling rate</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_tracer_provider</span><span class="p">()</span>
<a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampler: </span><span class="si">{</span><span class="n">provider</span><span class="o">.</span><span class="n">sampler</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></li>
</ol>
<p>If <code>ALWAYS_ON</code>: Consider sampling
   <div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">TraceIdRatioBased</span>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="n">sampler</span> <span class="o">=</span> <span class="n">TraceIdRatioBased</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 10% sampling</span>
</code></pre></div></p>
<ol>
<li>
<p><strong>Check batch processor settings</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="c1"># Increase batch size to reduce export frequency</span>
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchSpanProcessor</span><span class="p">(</span>
<a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>    <span class="n">exporter</span><span class="p">,</span>
<a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>    <span class="n">schedule_delay_millis</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>  <span class="c1"># Export every 10s</span>
<a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a>    <span class="n">max_export_batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>   <span class="c1"># Larger batches</span>
<a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Disable tracing temporarily</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">DATA_BRIDGE_TRACING_ENABLED</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Profile span creation</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>    <span class="k">pass</span>
<a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Span overhead: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="issue-missing-spans">Issue: "Missing spans"<a class="headerlink" href="#issue-missing-spans" title="Permanent link">&para;</a></h4>
<p><strong>Symptoms</strong>:
- Some operations don't create spans
- Incomplete traces</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p><strong>Check fast-path optimization</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="c1"># If tracer is None, spans won&#39;t be created</span>
<a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_tracer</span>
<a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a><span class="n">tracer</span> <span class="o">=</span> <span class="n">get_tracer</span><span class="p">()</span>
<a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracer: </span><span class="si">{</span><span class="n">tracer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Should not be None</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Verify span context propagation</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="c1"># Check if parent span exists</span>
<a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a><span class="n">current_span</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">()</span>
<a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current span: </span><span class="si">{</span><span class="n">current_span</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Enable debug logging</strong>:
   <div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;opentelemetry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="issue-high-cardinality-warnings">Issue: "High cardinality warnings"<a class="headerlink" href="#issue-high-cardinality-warnings" title="Permanent link">&para;</a></h4>
<p><strong>Symptoms</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a>WARNING: High cardinality detected in span name: db.query.find.user.12345
</code></pre></div></p>
<p><strong>Solution</strong>:</p>
<p>Don't include unique values in span names:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="c1"># ❌ Bad</span>
<a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="n">span_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;db.query.find.user.</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a>
<a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a><span class="c1"># ✅ Good</span>
<a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a><span class="n">span_name</span> <span class="o">=</span> <span class="s2">&quot;db.query.find&quot;</span>
<a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a><span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>  <span class="c1"># Use attributes instead</span>
</code></pre></div>
<h3 id="debugging-tips">Debugging Tips<a class="headerlink" href="#debugging-tips" title="Permanent link">&para;</a></h3>
<h4 id="enable-verbose-logging">Enable Verbose Logging<a class="headerlink" href="#enable-verbose-logging" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a>
<a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a><span class="c1"># Enable OpenTelemetry debug logs</span>
<a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;opentelemetry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a>
<a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a><span class="c1"># Enable data-bridge telemetry logs</span>
<a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;data_bridge.postgres.telemetry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</code></pre></div>
<h4 id="console-exporter-development">Console Exporter (Development)<a class="headerlink" href="#console-exporter-development" title="Permanent link">&para;</a></h4>
<p>See spans immediately in console:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConsoleSpanExporter</span><span class="p">,</span> <span class="n">SimpleSpanProcessor</span>
<a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a>
<a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">()</span>
<a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">SimpleSpanProcessor</span><span class="p">(</span><span class="n">ConsoleSpanExporter</span><span class="p">()))</span>
<a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a><span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
<a id="__codelineno-112-6" name="__codelineno-112-6" href="#__codelineno-112-6"></a>
<a id="__codelineno-112-7" name="__codelineno-112-7" href="#__codelineno-112-7"></a><span class="c1"># Spans will print to console</span>
</code></pre></div>
<p><strong>Output</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="p">{</span>
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a><span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;db.query.find&quot;</span><span class="p">,</span>
<a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a><span class="w">    </span><span class="nt">&quot;context&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a><span class="w">        </span><span class="nt">&quot;trace_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0x...&quot;</span><span class="p">,</span>
<a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a><span class="w">        </span><span class="nt">&quot;span_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0x...&quot;</span><span class="p">,</span>
<a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a><span class="w">        </span><span class="nt">&quot;trace_state&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;[]&quot;</span>
<a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a><span class="w">    </span><span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SpanKind.INTERNAL&quot;</span><span class="p">,</span>
<a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a><span class="w">    </span><span class="nt">&quot;parent_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0x...&quot;</span><span class="p">,</span>
<a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a><span class="w">    </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-01-06T10:30:00.123Z&quot;</span><span class="p">,</span>
<a id="__codelineno-113-11" name="__codelineno-113-11" href="#__codelineno-113-11"></a><span class="w">    </span><span class="nt">&quot;end_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2026-01-06T10:30:00.145Z&quot;</span><span class="p">,</span>
<a id="__codelineno-113-12" name="__codelineno-113-12" href="#__codelineno-113-12"></a><span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-113-13" name="__codelineno-113-13" href="#__codelineno-113-13"></a><span class="w">        </span><span class="nt">&quot;status_code&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OK&quot;</span>
<a id="__codelineno-113-14" name="__codelineno-113-14" href="#__codelineno-113-14"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-113-15" name="__codelineno-113-15" href="#__codelineno-113-15"></a><span class="w">    </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-113-16" name="__codelineno-113-16" href="#__codelineno-113-16"></a><span class="w">        </span><span class="nt">&quot;db.system&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgresql&quot;</span><span class="p">,</span>
<a id="__codelineno-113-17" name="__codelineno-113-17" href="#__codelineno-113-17"></a><span class="w">        </span><span class="nt">&quot;db.operation.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;find&quot;</span><span class="p">,</span>
<a id="__codelineno-113-18" name="__codelineno-113-18" href="#__codelineno-113-18"></a><span class="w">        </span><span class="nt">&quot;db.collection.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;users&quot;</span><span class="p">,</span>
<a id="__codelineno-113-19" name="__codelineno-113-19" href="#__codelineno-113-19"></a><span class="w">        </span><span class="nt">&quot;db.result.count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
<a id="__codelineno-113-20" name="__codelineno-113-20" href="#__codelineno-113-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-113-21" name="__codelineno-113-21" href="#__codelineno-113-21"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="verify-span-export">Verify Span Export<a class="headerlink" href="#verify-span-export" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="c1"># Add custom processor to count exported spans</span>
<a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CountingProcessor</span><span class="p">:</span>
<a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a>
<a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">,</span> <span class="n">parent_context</span><span class="p">):</span>
<a id="__codelineno-114-7" name="__codelineno-114-7" href="#__codelineno-114-7"></a>        <span class="k">pass</span>
<a id="__codelineno-114-8" name="__codelineno-114-8" href="#__codelineno-114-8"></a>
<a id="__codelineno-114-9" name="__codelineno-114-9" href="#__codelineno-114-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
<a id="__codelineno-114-10" name="__codelineno-114-10" href="#__codelineno-114-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-114-11" name="__codelineno-114-11" href="#__codelineno-114-11"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Span exported: </span><span class="si">{</span><span class="n">span</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (total: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-114-12" name="__codelineno-114-12" href="#__codelineno-114-12"></a>
<a id="__codelineno-114-13" name="__codelineno-114-13" href="#__codelineno-114-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-114-14" name="__codelineno-114-14" href="#__codelineno-114-14"></a>        <span class="k">pass</span>
<a id="__codelineno-114-15" name="__codelineno-114-15" href="#__codelineno-114-15"></a>
<a id="__codelineno-114-16" name="__codelineno-114-16" href="#__codelineno-114-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">force_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout_millis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-114-17" name="__codelineno-114-17" href="#__codelineno-114-17"></a>        <span class="k">pass</span>
<a id="__codelineno-114-18" name="__codelineno-114-18" href="#__codelineno-114-18"></a>
<a id="__codelineno-114-19" name="__codelineno-114-19" href="#__codelineno-114-19"></a><span class="n">counter</span> <span class="o">=</span> <span class="n">CountingProcessor</span><span class="p">()</span>
<a id="__codelineno-114-20" name="__codelineno-114-20" href="#__codelineno-114-20"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
</code></pre></div>
<h4 id="test-otlp-connectivity">Test OTLP Connectivity<a class="headerlink" href="#test-otlp-connectivity" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a><span class="c1"># Test gRPC endpoint</span>
<a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a>grpcurl<span class="w"> </span>-plaintext<span class="w"> </span>localhost:4317<span class="w"> </span>list
<a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a>
<a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a><span class="c1"># Test HTTP endpoint</span>
<a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:4318/v1/traces<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-115-6" name="__codelineno-115-6" href="#__codelineno-115-6"></a><span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-115-7" name="__codelineno-115-7" href="#__codelineno-115-7"></a><span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;resourceSpans&quot;: []}&#39;</span>
</code></pre></div>
<hr />
<h2 id="integration-examples">Integration Examples<a class="headerlink" href="#integration-examples" title="Permanent link">&para;</a></h2>
<h3 id="fastapi-integration">FastAPI Integration<a class="headerlink" href="#fastapi-integration" title="Permanent link">&para;</a></h3>
<p>See complete example: <a href="../examples/fastapi_otel_example.py"><code>examples/fastapi_otel_example.py</code></a></p>
<p><strong>Quick setup</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.instrumentation.fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPIInstrumentor</span>
<a id="__codelineno-116-4" name="__codelineno-116-4" href="#__codelineno-116-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracerProvider</span>
<a id="__codelineno-116-5" name="__codelineno-116-5" href="#__codelineno-116-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchSpanProcessor</span>
<a id="__codelineno-116-6" name="__codelineno-116-6" href="#__codelineno-116-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.exporter.otlp.proto.grpc.trace_exporter</span><span class="w"> </span><span class="kn">import</span> <span class="n">OTLPSpanExporter</span>
<a id="__codelineno-116-7" name="__codelineno-116-7" href="#__codelineno-116-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<a id="__codelineno-116-8" name="__codelineno-116-8" href="#__codelineno-116-8"></a>
<a id="__codelineno-116-9" name="__codelineno-116-9" href="#__codelineno-116-9"></a><span class="c1"># Configure OpenTelemetry</span>
<a id="__codelineno-116-10" name="__codelineno-116-10" href="#__codelineno-116-10"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">()</span>
<a id="__codelineno-116-11" name="__codelineno-116-11" href="#__codelineno-116-11"></a><span class="n">exporter</span> <span class="o">=</span> <span class="n">OTLPSpanExporter</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;http://localhost:4317&quot;</span><span class="p">,</span> <span class="n">insecure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-116-12" name="__codelineno-116-12" href="#__codelineno-116-12"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">BatchSpanProcessor</span><span class="p">(</span><span class="n">exporter</span><span class="p">))</span>
<a id="__codelineno-116-13" name="__codelineno-116-13" href="#__codelineno-116-13"></a><span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
<a id="__codelineno-116-14" name="__codelineno-116-14" href="#__codelineno-116-14"></a>
<a id="__codelineno-116-15" name="__codelineno-116-15" href="#__codelineno-116-15"></a><span class="c1"># Create FastAPI app</span>
<a id="__codelineno-116-16" name="__codelineno-116-16" href="#__codelineno-116-16"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-116-17" name="__codelineno-116-17" href="#__codelineno-116-17"></a>
<a id="__codelineno-116-18" name="__codelineno-116-18" href="#__codelineno-116-18"></a><span class="c1"># Auto-instrument FastAPI</span>
<a id="__codelineno-116-19" name="__codelineno-116-19" href="#__codelineno-116-19"></a><span class="n">FastAPIInstrumentor</span><span class="o">.</span><span class="n">instrument_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-116-20" name="__codelineno-116-20" href="#__codelineno-116-20"></a>
<a id="__codelineno-116-21" name="__codelineno-116-21" href="#__codelineno-116-21"></a><span class="c1"># Define model</span>
<a id="__codelineno-116-22" name="__codelineno-116-22" href="#__codelineno-116-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
<a id="__codelineno-116-23" name="__codelineno-116-23" href="#__codelineno-116-23"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-116-24" name="__codelineno-116-24" href="#__codelineno-116-24"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-116-25" name="__codelineno-116-25" href="#__codelineno-116-25"></a>
<a id="__codelineno-116-26" name="__codelineno-116-26" href="#__codelineno-116-26"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">:</span>
<a id="__codelineno-116-27" name="__codelineno-116-27" href="#__codelineno-116-27"></a>        <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
<a id="__codelineno-116-28" name="__codelineno-116-28" href="#__codelineno-116-28"></a>
<a id="__codelineno-116-29" name="__codelineno-116-29" href="#__codelineno-116-29"></a><span class="c1"># Database session</span>
<a id="__codelineno-116-30" name="__codelineno-116-30" href="#__codelineno-116-30"></a><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="s2">&quot;postgresql://localhost/mydb&quot;</span><span class="p">)</span>
<a id="__codelineno-116-31" name="__codelineno-116-31" href="#__codelineno-116-31"></a>
<a id="__codelineno-116-32" name="__codelineno-116-32" href="#__codelineno-116-32"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-116-33" name="__codelineno-116-33" href="#__codelineno-116-33"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-116-34" name="__codelineno-116-34" href="#__codelineno-116-34"></a>    <span class="c1"># Automatically creates trace:</span>
<a id="__codelineno-116-35" name="__codelineno-116-35" href="#__codelineno-116-35"></a>    <span class="c1"># HTTP span (from FastAPI) → ORM span (from data-bridge)</span>
<a id="__codelineno-116-36" name="__codelineno-116-36" href="#__codelineno-116-36"></a>    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-116-37" name="__codelineno-116-37" href="#__codelineno-116-37"></a>    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p><strong>Trace structure</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a>GET /users/1
<a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a>├─ FastAPI span
<a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a>│  ├─ http.method: GET
<a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a>│  ├─ http.route: /users/{user_id}
<a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a>│  └─ http.status_code: 200
<a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a>│
<a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a>└─ data-bridge span
<a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a>   ├─ db.query.find
<a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a>   ├─ db.collection.name: users
<a id="__codelineno-117-10" name="__codelineno-117-10" href="#__codelineno-117-10"></a>   └─ db.result.count: 1
</code></pre></div></p>
<p><strong>See also</strong>:
- <a href="../examples/QUICKSTART_FASTAPI_OTEL.md">FastAPI Quick Start</a>
- <a href="../examples/README_FASTAPI_OTEL.md">Full FastAPI Example</a>
- <a href="../examples/TRACE_EXAMPLES.md">Trace Examples</a></p>
<h3 id="standalone-scripts">Standalone Scripts<a class="headerlink" href="#standalone-scripts" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracerProvider</span>
<a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.export</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConsoleSpanExporter</span><span class="p">,</span> <span class="n">SimpleSpanProcessor</span>
<a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a>
<a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a><span class="c1"># Configure tracing</span>
<a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a><span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">()</span>
<a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a><span class="n">provider</span><span class="o">.</span><span class="n">add_span_processor</span><span class="p">(</span><span class="n">SimpleSpanProcessor</span><span class="p">(</span><span class="n">ConsoleSpanExporter</span><span class="p">()))</span>
<a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a><span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
<a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a>
<a id="__codelineno-118-12" name="__codelineno-118-12" href="#__codelineno-118-12"></a><span class="c1"># Define model</span>
<a id="__codelineno-118-13" name="__codelineno-118-13" href="#__codelineno-118-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
<a id="__codelineno-118-14" name="__codelineno-118-14" href="#__codelineno-118-14"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-118-15" name="__codelineno-118-15" href="#__codelineno-118-15"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-118-16" name="__codelineno-118-16" href="#__codelineno-118-16"></a>
<a id="__codelineno-118-17" name="__codelineno-118-17" href="#__codelineno-118-17"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">:</span>
<a id="__codelineno-118-18" name="__codelineno-118-18" href="#__codelineno-118-18"></a>        <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
<a id="__codelineno-118-19" name="__codelineno-118-19" href="#__codelineno-118-19"></a>
<a id="__codelineno-118-20" name="__codelineno-118-20" href="#__codelineno-118-20"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-118-21" name="__codelineno-118-21" href="#__codelineno-118-21"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="s2">&quot;postgresql://localhost/mydb&quot;</span><span class="p">)</span>
<a id="__codelineno-118-22" name="__codelineno-118-22" href="#__codelineno-118-22"></a>
<a id="__codelineno-118-23" name="__codelineno-118-23" href="#__codelineno-118-23"></a>    <span class="c1"># Traced query</span>
<a id="__codelineno-118-24" name="__codelineno-118-24" href="#__codelineno-118-24"></a>    <span class="n">users</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-118-25" name="__codelineno-118-25" href="#__codelineno-118-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="si">}</span><span class="s2"> users&quot;</span><span class="p">)</span>
<a id="__codelineno-118-26" name="__codelineno-118-26" href="#__codelineno-118-26"></a>
<a id="__codelineno-118-27" name="__codelineno-118-27" href="#__codelineno-118-27"></a>    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-118-28" name="__codelineno-118-28" href="#__codelineno-118-28"></a>
<a id="__codelineno-118-29" name="__codelineno-118-29" href="#__codelineno-118-29"></a><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p><strong>Output</strong> (console exporter):
<div class="highlight"><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="p">{</span>
<a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;db.query.find&quot;</span><span class="p">,</span>
<a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a><span class="w">    </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a><span class="w">        </span><span class="nt">&quot;db.system&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;postgresql&quot;</span><span class="p">,</span>
<a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a><span class="w">        </span><span class="nt">&quot;db.operation.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;find&quot;</span><span class="p">,</span>
<a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a><span class="w">        </span><span class="nt">&quot;db.collection.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;users&quot;</span><span class="p">,</span>
<a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a><span class="w">        </span><span class="nt">&quot;db.result.count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a><span class="w">    </span><span class="nt">&quot;start_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a><span class="w">    </span><span class="nt">&quot;end_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span>
<a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="pytest-integration-future">Pytest Integration (Future)<a class="headerlink" href="#pytest-integration-future" title="Permanent link">&para;</a></h3>
<p><strong>Planned feature</strong>: Pytest plugin for trace collection during tests</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="c1"># Future: pytest-opentelemetry plugin</span>
<a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="n">pytest</span> <span class="o">--</span><span class="n">trace</span><span class="o">-</span><span class="n">export</span><span class="o">=</span><span class="n">jaeger</span> <span class="n">tests</span><span class="o">/</span>
<a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a>
<a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a><span class="c1"># Or programmatic in conftest.py</span>
<a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure_tracing</span><span class="p">():</span>
<a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracerProvider</span>
<a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a>
<a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="n">TracerProvider</span><span class="p">()</span>
<a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a>    <span class="c1"># ... configure exporter</span>
<a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a>    <span class="n">trace</span><span class="o">.</span><span class="n">set_tracer_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="api-reference">API Reference<a class="headerlink" href="#api-reference" title="Permanent link">&para;</a></h2>
<h3 id="telemetry-module"><code>telemetry</code> Module<a class="headerlink" href="#telemetry-module" title="Permanent link">&para;</a></h3>
<p>Complete API documentation for <code>data_bridge.postgres.telemetry</code>.</p>
<h4 id="configuration-functions">Configuration Functions<a class="headerlink" href="#configuration-functions" title="Permanent link">&para;</a></h4>
<h5 id="is_tracing_enabled-bool"><code>is_tracing_enabled() -&gt; bool</code><a class="headerlink" href="#is_tracing_enabled-bool" title="Permanent link">&para;</a></h5>
<p>Check if tracing is currently enabled.</p>
<p><strong>Returns</strong>: <code>True</code> if OpenTelemetry SDK is installed and tracing is not explicitly disabled.</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_tracing_enabled</span>
<a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a>
<a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a><span class="k">if</span> <span class="n">is_tracing_enabled</span><span class="p">():</span>
<a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing is active&quot;</span><span class="p">)</span>
</code></pre></div></p>
<h5 id="get_tracer-optionaltracer"><code>get_tracer() -&gt; Optional[Tracer]</code><a class="headerlink" href="#get_tracer-optionaltracer" title="Permanent link">&para;</a></h5>
<p>Get the global tracer for data-bridge.</p>
<p><strong>Returns</strong>: <code>Tracer</code> instance if available, <code>None</code> otherwise.</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_tracer</span>
<a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a>
<a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a><span class="n">tracer</span> <span class="o">=</span> <span class="n">get_tracer</span><span class="p">()</span>
<a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a><span class="k">if</span> <span class="n">tracer</span><span class="p">:</span>
<a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>    <span class="k">with</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;custom.operation&quot;</span><span class="p">):</span>
<a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a>        <span class="c1"># Custom span</span>
<a id="__codelineno-122-7" name="__codelineno-122-7" href="#__codelineno-122-7"></a>        <span class="k">pass</span>
</code></pre></div></p>
<h5 id="get_meter-optionalmeter"><code>get_meter() -&gt; Optional[Meter]</code><a class="headerlink" href="#get_meter-optionalmeter" title="Permanent link">&para;</a></h5>
<p>Get the global meter for metrics.</p>
<p><strong>Returns</strong>: <code>Meter</code> instance if available, <code>None</code> otherwise.</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_meter</span>
<a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a>
<a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="n">meter</span> <span class="o">=</span> <span class="n">get_meter</span><span class="p">()</span>
<a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a><span class="k">if</span> <span class="n">meter</span><span class="p">:</span>
<a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a>    <span class="n">counter</span> <span class="o">=</span> <span class="n">meter</span><span class="o">.</span><span class="n">create_counter</span><span class="p">(</span><span class="s2">&quot;custom.counter&quot;</span><span class="p">)</span>
<a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a>    <span class="n">counter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="span-context-managers">Span Context Managers<a class="headerlink" href="#span-context-managers" title="Permanent link">&para;</a></h4>
<h5 id="create_query_span"><code>create_query_span(...)</code><a class="headerlink" href="#create_query_span" title="Permanent link">&para;</a></h5>
<p>Create a query span with database attributes.</p>
<p><strong>Signature</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="nd">@contextmanager</span>
<a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_query_span</span><span class="p">(</span>
<a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a>    <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-124-4" name="__codelineno-124-4" href="#__codelineno-124-4"></a>    <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-124-5" name="__codelineno-124-5" href="#__codelineno-124-5"></a>    <span class="n">filters_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-124-6" name="__codelineno-124-6" href="#__codelineno-124-6"></a>    <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-124-7" name="__codelineno-124-7" href="#__codelineno-124-7"></a>    <span class="n">offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-124-8" name="__codelineno-124-8" href="#__codelineno-124-8"></a>    <span class="n">order_by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-124-9" name="__codelineno-124-9" href="#__codelineno-124-9"></a>    <span class="n">statement</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-124-10" name="__codelineno-124-10" href="#__codelineno-124-10"></a>    <span class="o">**</span><span class="n">attributes</span><span class="p">:</span> <span class="n">Any</span>
<a id="__codelineno-124-11" name="__codelineno-124-11" href="#__codelineno-124-11"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Span</span><span class="p">]]</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>operation</code>: Operation type (e.g., "find", "insert", "update")
- <code>table</code>: Table name
- <code>filters_count</code>: Number of WHERE conditions
- <code>limit</code>: LIMIT value
- <code>offset</code>: OFFSET value
- <code>order_by</code>: ORDER BY clause
- <code>statement</code>: SQL statement (use cautiously)
- <code>**attributes</code>: Additional custom attributes</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_query_span</span><span class="p">,</span> <span class="n">set_span_result</span>
<a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a>
<a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="n">filters_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">execute_query</span><span class="p">()</span>
<a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a>    <span class="n">set_span_result</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</code></pre></div></p>
<h5 id="create_session_span"><code>create_session_span(...)</code><a class="headerlink" href="#create_session_span" title="Permanent link">&para;</a></h5>
<p>Create a session span with state attributes.</p>
<p><strong>Signature</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="nd">@contextmanager</span>
<a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_session_span</span><span class="p">(</span>
<a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a>    <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a>    <span class="n">pending_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a>    <span class="n">dirty_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a>    <span class="n">deleted_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a>    <span class="o">**</span><span class="n">attributes</span><span class="p">:</span> <span class="n">Any</span>
<a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Span</span><span class="p">]]</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>operation</code>: Session operation (e.g., "flush", "commit", "rollback")
- <code>pending_count</code>: Number of pending (new) objects
- <code>dirty_count</code>: Number of modified objects
- <code>deleted_count</code>: Number of deleted objects
- <code>**attributes</code>: Additional custom attributes</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_session_span</span>
<a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a>
<a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a><span class="k">with</span> <span class="n">create_session_span</span><span class="p">(</span><span class="s2">&quot;flush&quot;</span><span class="p">,</span> <span class="n">pending_count</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dirty_count</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a>    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div></p>
<h5 id="create_relationship_span"><code>create_relationship_span(...)</code><a class="headerlink" href="#create_relationship_span" title="Permanent link">&para;</a></h5>
<p>Create a relationship loading span.</p>
<p><strong>Signature</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="nd">@contextmanager</span>
<a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_relationship_span</span><span class="p">(</span>
<a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a>    <span class="n">target_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a>    <span class="n">strategy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a>    <span class="n">fk_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a>    <span class="n">batch_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a>    <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a>    <span class="o">**</span><span class="n">attributes</span><span class="p">:</span> <span class="n">Any</span>
<a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Span</span><span class="p">]]</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>name</code>: Relationship name
- <code>target_model</code>: Target model class name
- <code>strategy</code>: Loading strategy ("select", "selectinload", etc.)
- <code>fk_column</code>: Foreign key column
- <code>batch_count</code>: Number of instances in batch (eager loading)
- <code>depth</code>: Nesting depth (0 = top-level)
- <code>**attributes</code>: Additional custom attributes</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_relationship_span</span><span class="p">,</span> <span class="n">set_span_result</span>
<a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a>
<a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a><span class="k">with</span> <span class="n">create_relationship_span</span><span class="p">(</span><span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="n">target_model</span><span class="o">=</span><span class="s2">&quot;Post&quot;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a>    <span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">load_relationship</span><span class="p">()</span>
<a id="__codelineno-129-5" name="__codelineno-129-5" href="#__codelineno-129-5"></a>    <span class="n">set_span_result</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">posts</span><span class="p">),</span> <span class="n">cache_hit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="helper-functions">Helper Functions<a class="headerlink" href="#helper-functions" title="Permanent link">&para;</a></h4>
<h5 id="add_exceptionspan-exception"><code>add_exception(span, exception)</code><a class="headerlink" href="#add_exceptionspan-exception" title="Permanent link">&para;</a></h5>
<p>Record an exception in a span.</p>
<p><strong>Signature</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">add_exception</span><span class="p">(</span><span class="n">span</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Span</span><span class="p">],</span> <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>span</code>: Span to add exception to
- <code>exception</code>: Exception to record</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_query_span</span><span class="p">,</span> <span class="n">add_exception</span>
<a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a>
<a id="__codelineno-131-3" name="__codelineno-131-3" href="#__codelineno-131-3"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-131-4" name="__codelineno-131-4" href="#__codelineno-131-4"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-131-5" name="__codelineno-131-5" href="#__codelineno-131-5"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="p">()</span>
<a id="__codelineno-131-6" name="__codelineno-131-6" href="#__codelineno-131-6"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-131-7" name="__codelineno-131-7" href="#__codelineno-131-7"></a>        <span class="n">add_exception</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-131-8" name="__codelineno-131-8" href="#__codelineno-131-8"></a>        <span class="k">raise</span>
</code></pre></div></p>
<h5 id="set_span_result"><code>set_span_result(...)</code><a class="headerlink" href="#set_span_result" title="Permanent link">&para;</a></h5>
<p>Set result attributes on a span.</p>
<p><strong>Signature</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_span_result</span><span class="p">(</span>
<a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a>    <span class="n">span</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Span</span><span class="p">],</span>
<a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a>    <span class="n">count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a>    <span class="n">affected_rows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a>    <span class="n">cache_hit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-132-6" name="__codelineno-132-6" href="#__codelineno-132-6"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<a id="__codelineno-132-7" name="__codelineno-132-7" href="#__codelineno-132-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>span</code>: Span to update
- <code>count</code>: Number of results
- <code>affected_rows</code>: Number of rows modified
- <code>cache_hit</code>: Whether result from cache
- <code>**kwargs</code>: Additional custom attributes</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_span_result</span>
<a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a>
<a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-133-4" name="__codelineno-133-4" href="#__codelineno-133-4"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="p">()</span>
<a id="__codelineno-133-5" name="__codelineno-133-5" href="#__codelineno-133-5"></a>    <span class="n">set_span_result</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</code></pre></div></p>
<h4 id="decorators">Decorators<a class="headerlink" href="#decorators" title="Permanent link">&para;</a></h4>
<h5 id="instrument_span"><code>@instrument_span(...)</code><a class="headerlink" href="#instrument_span" title="Permanent link">&para;</a></h5>
<p>Decorate a function to create a span.</p>
<p><strong>Signature</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">instrument_span</span><span class="p">(</span>
<a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a>    <span class="n">attributes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">F</span><span class="p">],</span> <span class="n">F</span><span class="p">]</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>name</code>: Span name (defaults to <code>module.function</code>)
- <code>attributes</code>: Additional attributes</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">instrument_span</span>
<a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a>
<a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a><span class="nd">@instrument_span</span><span class="p">(</span><span class="s2">&quot;custom.operation&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;business-logic&quot;</span><span class="p">})</span>
<a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a>    <span class="c1"># Function body</span>
<a id="__codelineno-135-6" name="__codelineno-135-6" href="#__codelineno-135-6"></a>    <span class="k">pass</span>
</code></pre></div></p>
<h5 id="instrument_query"><code>@instrument_query(...)</code><a class="headerlink" href="#instrument_query" title="Permanent link">&para;</a></h5>
<p>Decorate a query function.</p>
<p><strong>Signature</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">instrument_query</span><span class="p">(</span><span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">F</span><span class="p">],</span> <span class="n">F</span><span class="p">]</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>operation</code>: Operation type (e.g., "find", "insert")</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">instrument_query</span>
<a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a>
<a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a><span class="nd">@instrument_query</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">)</span>
<a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_users</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>
<a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</code></pre></div></p>
<h5 id="instrument_session"><code>@instrument_session(...)</code><a class="headerlink" href="#instrument_session" title="Permanent link">&para;</a></h5>
<p>Decorate a session function.</p>
<p><strong>Signature</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">instrument_session</span><span class="p">(</span><span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">F</span><span class="p">],</span> <span class="n">F</span><span class="p">]</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>operation</code>: Session operation (e.g., "flush", "commit")</p>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">instrument_session</span>
<a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a>
<a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a><span class="nd">@instrument_session</span><span class="p">(</span><span class="s2">&quot;flush&quot;</span><span class="p">)</span>
<a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">flush_changes</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
<a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a>    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div></p>
<h4 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link">&para;</a></h4>
<h5 id="connectionpoolmetrics"><code>ConnectionPoolMetrics</code><a class="headerlink" href="#connectionpoolmetrics" title="Permanent link">&para;</a></h5>
<p>Connection pool metrics collector.</p>
<p><strong>Methods</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConnectionPoolMetrics</span><span class="p">:</span>
<a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">record_pool_stats</span><span class="p">(</span>
<a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a>        <span class="n">in_use</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a>        <span class="n">idle</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a>        <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record connection pool statistics.&quot;&quot;&quot;</span>
</code></pre></div>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_connection_pool_metrics</span>
<a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a>
<a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a><span class="n">metrics</span> <span class="o">=</span> <span class="n">get_connection_pool_metrics</span><span class="p">()</span>
<a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a><span class="n">metrics</span><span class="o">.</span><span class="n">record_pool_stats</span><span class="p">(</span><span class="n">in_use</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">idle</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="constants">Constants<a class="headerlink" href="#constants" title="Permanent link">&para;</a></h4>
<h5 id="spanattributes"><code>SpanAttributes</code><a class="headerlink" href="#spanattributes" title="Permanent link">&para;</a></h5>
<p>Semantic convention constants:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SpanAttributes</span><span class="p">:</span>
<a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a>    <span class="n">DB_SYSTEM</span> <span class="o">=</span> <span class="s2">&quot;db.system&quot;</span>
<a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a>    <span class="n">DB_OPERATION_NAME</span> <span class="o">=</span> <span class="s2">&quot;db.operation.name&quot;</span>
<a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a>    <span class="n">DB_COLLECTION_NAME</span> <span class="o">=</span> <span class="s2">&quot;db.collection.name&quot;</span>
<a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a>    <span class="n">DB_STATEMENT</span> <span class="o">=</span> <span class="s2">&quot;db.statement&quot;</span>
<a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a>    <span class="n">DB_QUERY_FILTERS_COUNT</span> <span class="o">=</span> <span class="s2">&quot;db.query.filters_count&quot;</span>
<a id="__codelineno-142-7" name="__codelineno-142-7" href="#__codelineno-142-7"></a>    <span class="n">DB_QUERY_LIMIT</span> <span class="o">=</span> <span class="s2">&quot;db.query.limit&quot;</span>
<a id="__codelineno-142-8" name="__codelineno-142-8" href="#__codelineno-142-8"></a>    <span class="n">DB_QUERY_OFFSET</span> <span class="o">=</span> <span class="s2">&quot;db.query.offset&quot;</span>
<a id="__codelineno-142-9" name="__codelineno-142-9" href="#__codelineno-142-9"></a>    <span class="n">DB_QUERY_ORDER_BY</span> <span class="o">=</span> <span class="s2">&quot;db.query.order_by&quot;</span>
<a id="__codelineno-142-10" name="__codelineno-142-10" href="#__codelineno-142-10"></a>    <span class="n">DB_RESULT_COUNT</span> <span class="o">=</span> <span class="s2">&quot;db.result.count&quot;</span>
<a id="__codelineno-142-11" name="__codelineno-142-11" href="#__codelineno-142-11"></a>    <span class="n">DB_RESULT_AFFECTED_ROWS</span> <span class="o">=</span> <span class="s2">&quot;db.result.affected_rows&quot;</span>
<a id="__codelineno-142-12" name="__codelineno-142-12" href="#__codelineno-142-12"></a>    <span class="n">DB_SESSION_OPERATION</span> <span class="o">=</span> <span class="s2">&quot;db.session.operation&quot;</span>
<a id="__codelineno-142-13" name="__codelineno-142-13" href="#__codelineno-142-13"></a>    <span class="n">DB_SESSION_PENDING_COUNT</span> <span class="o">=</span> <span class="s2">&quot;db.session.pending_count&quot;</span>
<a id="__codelineno-142-14" name="__codelineno-142-14" href="#__codelineno-142-14"></a>    <span class="n">DB_SESSION_DIRTY_COUNT</span> <span class="o">=</span> <span class="s2">&quot;db.session.dirty_count&quot;</span>
<a id="__codelineno-142-15" name="__codelineno-142-15" href="#__codelineno-142-15"></a>    <span class="n">DB_SESSION_DELETED_COUNT</span> <span class="o">=</span> <span class="s2">&quot;db.session.deleted_count&quot;</span>
<a id="__codelineno-142-16" name="__codelineno-142-16" href="#__codelineno-142-16"></a>    <span class="n">DB_RELATIONSHIP_NAME</span> <span class="o">=</span> <span class="s2">&quot;db.relationship.name&quot;</span>
<a id="__codelineno-142-17" name="__codelineno-142-17" href="#__codelineno-142-17"></a>    <span class="n">DB_RELATIONSHIP_TARGET_MODEL</span> <span class="o">=</span> <span class="s2">&quot;db.relationship.target_model&quot;</span>
<a id="__codelineno-142-18" name="__codelineno-142-18" href="#__codelineno-142-18"></a>    <span class="n">DB_RELATIONSHIP_STRATEGY</span> <span class="o">=</span> <span class="s2">&quot;db.relationship.strategy&quot;</span>
<a id="__codelineno-142-19" name="__codelineno-142-19" href="#__codelineno-142-19"></a>    <span class="n">DB_RELATIONSHIP_FK_COLUMN</span> <span class="o">=</span> <span class="s2">&quot;db.relationship.fk_column&quot;</span>
<a id="__codelineno-142-20" name="__codelineno-142-20" href="#__codelineno-142-20"></a>    <span class="n">DB_RELATIONSHIP_CACHE_HIT</span> <span class="o">=</span> <span class="s2">&quot;db.relationship.cache_hit&quot;</span>
<a id="__codelineno-142-21" name="__codelineno-142-21" href="#__codelineno-142-21"></a>    <span class="n">DB_RELATIONSHIP_BATCH_COUNT</span> <span class="o">=</span> <span class="s2">&quot;db.relationship.batch_count&quot;</span>
<a id="__codelineno-142-22" name="__codelineno-142-22" href="#__codelineno-142-22"></a>    <span class="n">DB_RELATIONSHIP_DEPTH</span> <span class="o">=</span> <span class="s2">&quot;db.relationship.depth&quot;</span>
</code></pre></div>
<h5 id="metricnames"><code>MetricNames</code><a class="headerlink" href="#metricnames" title="Permanent link">&para;</a></h5>
<p>Metric name constants:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MetricNames</span><span class="p">:</span>
<a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a>    <span class="n">CONNECTION_POOL_IN_USE</span> <span class="o">=</span> <span class="s2">&quot;db.connection.pool.in_use&quot;</span>
<a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a>    <span class="n">CONNECTION_POOL_IDLE</span> <span class="o">=</span> <span class="s2">&quot;db.connection.pool.idle&quot;</span>
<a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a>    <span class="n">CONNECTION_POOL_MAX</span> <span class="o">=</span> <span class="s2">&quot;db.connection.pool.max&quot;</span>
<a id="__codelineno-143-5" name="__codelineno-143-5" href="#__codelineno-143-5"></a>    <span class="n">QUERY_DURATION</span> <span class="o">=</span> <span class="s2">&quot;db.query.duration&quot;</span>
<a id="__codelineno-143-6" name="__codelineno-143-6" href="#__codelineno-143-6"></a>    <span class="n">QUERY_COUNT</span> <span class="o">=</span> <span class="s2">&quot;db.query.count&quot;</span>
</code></pre></div>
<hr />
<h2 id="future-enhancements">Future Enhancements<a class="headerlink" href="#future-enhancements" title="Permanent link">&para;</a></h2>
<h3 id="planned-features">Planned Features<a class="headerlink" href="#planned-features" title="Permanent link">&para;</a></h3>
<h4 id="1-automatic-n1-detection-warnings">1. Automatic N+1 Detection Warnings<a class="headerlink" href="#1-automatic-n1-detection-warnings" title="Permanent link">&para;</a></h4>
<p>Emit warning spans when N+1 threshold exceeded:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a><span class="c1"># Automatic detection (planned)</span>
<a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a><span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a>
<a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
<a id="__codelineno-144-5" name="__codelineno-144-5" href="#__codelineno-144-5"></a>    <span class="n">author</span> <span class="o">=</span> <span class="k">await</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span>  <span class="c1"># After 10 accesses, warning emitted</span>
<a id="__codelineno-144-6" name="__codelineno-144-6" href="#__codelineno-144-6"></a>
<a id="__codelineno-144-7" name="__codelineno-144-7" href="#__codelineno-144-7"></a><span class="c1"># Warning span (future):</span>
<a id="__codelineno-144-8" name="__codelineno-144-8" href="#__codelineno-144-8"></a><span class="c1"># Name: db.n1_warning</span>
<a id="__codelineno-144-9" name="__codelineno-144-9" href="#__codelineno-144-9"></a><span class="c1"># Attributes:</span>
<a id="__codelineno-144-10" name="__codelineno-144-10" href="#__codelineno-144-10"></a><span class="c1">#   - db.relationship.name: author</span>
<a id="__codelineno-144-11" name="__codelineno-144-11" href="#__codelineno-144-11"></a><span class="c1">#   - db.n1.query_count: 10</span>
<a id="__codelineno-144-12" name="__codelineno-144-12" href="#__codelineno-144-12"></a><span class="c1">#   - db.n1.threshold: 5</span>
<a id="__codelineno-144-13" name="__codelineno-144-13" href="#__codelineno-144-13"></a><span class="c1">#   - db.n1.recommendation: &quot;Use selectinload(Post.author)&quot;</span>
</code></pre></div>
<p><strong>Configuration</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a><span class="c1"># Future API</span>
<a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">configure_n1_detection</span>
<a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a>
<a id="__codelineno-145-4" name="__codelineno-145-4" href="#__codelineno-145-4"></a><span class="n">configure_n1_detection</span><span class="p">(</span>
<a id="__codelineno-145-5" name="__codelineno-145-5" href="#__codelineno-145-5"></a>    <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-145-6" name="__codelineno-145-6" href="#__codelineno-145-6"></a>    <span class="n">threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># Warn after 5 lazy loads</span>
<a id="__codelineno-145-7" name="__codelineno-145-7" href="#__codelineno-145-7"></a>    <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">,</span>
<a id="__codelineno-145-8" name="__codelineno-145-8" href="#__codelineno-145-8"></a><span class="p">)</span>
</code></pre></div></p>
<h4 id="2-metrics-export-beyond-connection-pool">2. Metrics Export (Beyond Connection Pool)<a class="headerlink" href="#2-metrics-export-beyond-connection-pool" title="Permanent link">&para;</a></h4>
<p>Export query performance metrics:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="c1"># Future metrics (planned)</span>
<a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a><span class="n">meter</span> <span class="o">=</span> <span class="n">get_meter</span><span class="p">()</span>
<a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a>
<a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a><span class="c1"># Query duration histogram</span>
<a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a><span class="n">query_duration</span> <span class="o">=</span> <span class="n">meter</span><span class="o">.</span><span class="n">create_histogram</span><span class="p">(</span>
<a id="__codelineno-146-6" name="__codelineno-146-6" href="#__codelineno-146-6"></a>    <span class="s2">&quot;db.query.duration&quot;</span><span class="p">,</span>
<a id="__codelineno-146-7" name="__codelineno-146-7" href="#__codelineno-146-7"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Query execution time in milliseconds&quot;</span><span class="p">,</span>
<a id="__codelineno-146-8" name="__codelineno-146-8" href="#__codelineno-146-8"></a>    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;ms&quot;</span>
<a id="__codelineno-146-9" name="__codelineno-146-9" href="#__codelineno-146-9"></a><span class="p">)</span>
<a id="__codelineno-146-10" name="__codelineno-146-10" href="#__codelineno-146-10"></a>
<a id="__codelineno-146-11" name="__codelineno-146-11" href="#__codelineno-146-11"></a><span class="c1"># Query count counter</span>
<a id="__codelineno-146-12" name="__codelineno-146-12" href="#__codelineno-146-12"></a><span class="n">query_count</span> <span class="o">=</span> <span class="n">meter</span><span class="o">.</span><span class="n">create_counter</span><span class="p">(</span>
<a id="__codelineno-146-13" name="__codelineno-146-13" href="#__codelineno-146-13"></a>    <span class="s2">&quot;db.query.count&quot;</span><span class="p">,</span>
<a id="__codelineno-146-14" name="__codelineno-146-14" href="#__codelineno-146-14"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total number of queries executed&quot;</span>
<a id="__codelineno-146-15" name="__codelineno-146-15" href="#__codelineno-146-15"></a><span class="p">)</span>
<a id="__codelineno-146-16" name="__codelineno-146-16" href="#__codelineno-146-16"></a>
<a id="__codelineno-146-17" name="__codelineno-146-17" href="#__codelineno-146-17"></a><span class="c1"># Automatically recorded for all queries</span>
</code></pre></div>
<p><strong>Exported metrics</strong>:
- <code>db.query.duration</code> (histogram) - Query latency distribution
- <code>db.query.count</code> (counter) - Total queries by operation
- <code>db.connection.pool.in_use</code> (gauge) - Active connections
- <code>db.connection.pool.idle</code> (gauge) - Idle connections
- <code>db.session.transaction.duration</code> (histogram) - Transaction time</p>
<h4 id="3-custom-span-processors">3. Custom Span Processors<a class="headerlink" href="#3-custom-span-processors" title="Permanent link">&para;</a></h4>
<p>Support custom processors for advanced use cases:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a><span class="c1"># Future API (planned)</span>
<a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">data_bridge.postgres.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_span_processor</span>
<a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a>
<a id="__codelineno-147-4" name="__codelineno-147-4" href="#__codelineno-147-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomProcessor</span><span class="p">:</span>
<a id="__codelineno-147-5" name="__codelineno-147-5" href="#__codelineno-147-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">,</span> <span class="n">parent_context</span><span class="p">):</span>
<a id="__codelineno-147-6" name="__codelineno-147-6" href="#__codelineno-147-6"></a>        <span class="c1"># Custom logic on span start</span>
<a id="__codelineno-147-7" name="__codelineno-147-7" href="#__codelineno-147-7"></a>        <span class="k">pass</span>
<a id="__codelineno-147-8" name="__codelineno-147-8" href="#__codelineno-147-8"></a>
<a id="__codelineno-147-9" name="__codelineno-147-9" href="#__codelineno-147-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
<a id="__codelineno-147-10" name="__codelineno-147-10" href="#__codelineno-147-10"></a>        <span class="c1"># Custom logic on span end (e.g., log slow queries)</span>
<a id="__codelineno-147-11" name="__codelineno-147-11" href="#__codelineno-147-11"></a>        <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;db.query.find&quot;</span><span class="p">:</span>
<a id="__codelineno-147-12" name="__codelineno-147-12" href="#__codelineno-147-12"></a>            <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">span</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span>
<a id="__codelineno-147-13" name="__codelineno-147-13" href="#__codelineno-147-13"></a>            <span class="k">if</span> <span class="n">duration_ms</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
<a id="__codelineno-147-14" name="__codelineno-147-14" href="#__codelineno-147-14"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slow query detected: </span><span class="si">{</span><span class="n">duration_ms</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
<a id="__codelineno-147-15" name="__codelineno-147-15" href="#__codelineno-147-15"></a>
<a id="__codelineno-147-16" name="__codelineno-147-16" href="#__codelineno-147-16"></a><span class="n">add_span_processor</span><span class="p">(</span><span class="n">CustomProcessor</span><span class="p">())</span>
</code></pre></div>
<h4 id="4-span-links-for-async-operations">4. Span Links for Async Operations<a class="headerlink" href="#4-span-links-for-async-operations" title="Permanent link">&para;</a></h4>
<p>Link related async operations:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a><span class="c1"># Future: Span links for background tasks</span>
<a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a>    <span class="c1"># Main operation span</span>
<a id="__codelineno-148-4" name="__codelineno-148-4" href="#__codelineno-148-4"></a>    <span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">main_span</span><span class="p">:</span>
<a id="__codelineno-148-5" name="__codelineno-148-5" href="#__codelineno-148-5"></a>        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-148-6" name="__codelineno-148-6" href="#__codelineno-148-6"></a>
<a id="__codelineno-148-7" name="__codelineno-148-7" href="#__codelineno-148-7"></a>        <span class="c1"># Background task span (linked to main)</span>
<a id="__codelineno-148-8" name="__codelineno-148-8" href="#__codelineno-148-8"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
<a id="__codelineno-148-9" name="__codelineno-148-9" href="#__codelineno-148-9"></a>            <span class="n">send_welcome_email</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">parent_span</span><span class="o">=</span><span class="n">main_span</span><span class="p">)</span>
<a id="__codelineno-148-10" name="__codelineno-148-10" href="#__codelineno-148-10"></a>        <span class="p">)</span>
<a id="__codelineno-148-11" name="__codelineno-148-11" href="#__codelineno-148-11"></a>
<a id="__codelineno-148-12" name="__codelineno-148-12" href="#__codelineno-148-12"></a><span class="c1"># Creates span link:</span>
<a id="__codelineno-148-13" name="__codelineno-148-13" href="#__codelineno-148-13"></a><span class="c1"># send_welcome_email span → linked to → process_user span</span>
</code></pre></div>
<h4 id="5-sampling-based-on-attributes">5. Sampling Based on Attributes<a class="headerlink" href="#5-sampling-based-on-attributes" title="Permanent link">&para;</a></h4>
<p>Advanced sampling strategies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a><span class="c1"># Future: Attribute-based sampling (planned)</span>
<a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.sdk.trace.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttributeBasedSampler</span>
<a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a>
<a id="__codelineno-149-4" name="__codelineno-149-4" href="#__codelineno-149-4"></a><span class="n">sampler</span> <span class="o">=</span> <span class="n">AttributeBasedSampler</span><span class="p">(</span>
<a id="__codelineno-149-5" name="__codelineno-149-5" href="#__codelineno-149-5"></a>    <span class="c1"># Always sample slow queries</span>
<a id="__codelineno-149-6" name="__codelineno-149-6" href="#__codelineno-149-6"></a>    <span class="n">rules</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-149-7" name="__codelineno-149-7" href="#__codelineno-149-7"></a>        <span class="p">{</span><span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span> <span class="s2">&quot;sample&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
<a id="__codelineno-149-8" name="__codelineno-149-8" href="#__codelineno-149-8"></a>        <span class="p">{</span><span class="s2">&quot;db.operation.name&quot;</span><span class="p">:</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
<a id="__codelineno-149-9" name="__codelineno-149-9" href="#__codelineno-149-9"></a>        <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
<a id="__codelineno-149-10" name="__codelineno-149-10" href="#__codelineno-149-10"></a>    <span class="p">]</span>
<a id="__codelineno-149-11" name="__codelineno-149-11" href="#__codelineno-149-11"></a><span class="p">)</span>
</code></pre></div>
<h4 id="6-query-plan-export">6. Query Plan Export<a class="headerlink" href="#6-query-plan-export" title="Permanent link">&para;</a></h4>
<p>Export EXPLAIN output as span events:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a><span class="c1"># Future: Query plan export (planned)</span>
<a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a><span class="k">with</span> <span class="n">create_query_span</span><span class="p">(</span><span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="s2">&quot;users&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
<a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">query</span><span class="p">()</span>
<a id="__codelineno-150-4" name="__codelineno-150-4" href="#__codelineno-150-4"></a>
<a id="__codelineno-150-5" name="__codelineno-150-5" href="#__codelineno-150-5"></a>    <span class="c1"># Automatically adds query plan as event</span>
<a id="__codelineno-150-6" name="__codelineno-150-6" href="#__codelineno-150-6"></a>    <span class="c1"># span.add_event(&quot;query_plan&quot;, {</span>
<a id="__codelineno-150-7" name="__codelineno-150-7" href="#__codelineno-150-7"></a>    <span class="c1">#     &quot;plan&quot;: &quot;Seq Scan on users (cost=0.00..10.00 rows=100 width=32)&quot;</span>
<a id="__codelineno-150-8" name="__codelineno-150-8" href="#__codelineno-150-8"></a>    <span class="c1"># })</span>
</code></pre></div>
<h3 id="community-contributions-welcome">Community Contributions Welcome<a class="headerlink" href="#community-contributions-welcome" title="Permanent link">&para;</a></h3>
<p>We welcome contributions! Areas for improvement:</p>
<ol>
<li><strong>Additional backends</strong>: Azure Monitor, Google Cloud Trace examples</li>
<li><strong>Metrics exporters</strong>: Prometheus, StatsD</li>
<li><strong>Logging integration</strong>: Correlate logs with traces</li>
<li><strong>Sampling strategies</strong>: Custom samplers for specific use cases</li>
<li><strong>Documentation</strong>: More examples, tutorials, best practices</li>
</ol>
<p>See <a href="../CONTRIBUTING.md">CONTRIBUTING.md</a> for guidelines.</p>
<hr />
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<h3 id="official-documentation">Official Documentation<a class="headerlink" href="#official-documentation" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://opentelemetry.io/">OpenTelemetry Official Site</a></li>
<li><a href="https://opentelemetry.io/docs/instrumentation/python/">OpenTelemetry Python Documentation</a></li>
<li><a href="https://opentelemetry.io/docs/specs/semconv/">OpenTelemetry Semantic Conventions</a></li>
<li><a href="https://opentelemetry.io/docs/specs/semconv/database/">Database Semantic Conventions</a></li>
</ul>
<h3 id="data-bridge-documentation">data-bridge Documentation<a class="headerlink" href="#data-bridge-documentation" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="./postgres_orm_design.md">PostgreSQL ORM Design</a></li>
<li><a href="./postgres_transactions.md">PostgreSQL Transactions</a></li>
<li><a href="../POSTGRESQL_EXTENSIONS/">PostgreSQL Extensions</a></li>
<li><a href="../examples/README_FASTAPI_OTEL.md">FastAPI Example</a></li>
<li><a href="../examples/TRACE_EXAMPLES.md">Trace Examples</a></li>
<li><a href="../TELEMETRY_RELATIONSHIPS.md">Relationship Telemetry</a></li>
</ul>
<h3 id="backend-specific-docs">Backend-Specific Docs<a class="headerlink" href="#backend-specific-docs" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://www.jaegertracing.io/docs/">Jaeger Documentation</a></li>
<li><a href="https://grafana.com/docs/tempo/">Grafana Tempo</a></li>
<li><a href="https://docs.datadoghq.com/tracing/">DataDog APM</a></li>
<li><a href="https://docs.newrelic.com/docs/distributed-tracing/">New Relic Distributed Tracing</a></li>
<li><a href="https://docs.honeycomb.io/">Honeycomb</a></li>
</ul>
<h3 id="code-examples">Code Examples<a class="headerlink" href="#code-examples" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="../examples/telemetry_example.py">Standalone Example</a></li>
<li><a href="../examples/fastapi_otel_example.py">FastAPI Example</a></li>
<li><a href="../examples/otel_backends.env.example">Backend Configuration</a></li>
<li><a href="../tests/postgres/test_telemetry.py">Tests</a></li>
</ul>
<hr />
<h2 id="support">Support<a class="headerlink" href="#support" title="Permanent link">&para;</a></h2>
<h3 id="getting-help">Getting Help<a class="headerlink" href="#getting-help" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>GitHub Issues</strong>: https://github.com/your-org/data-bridge/issues</li>
<li><strong>Discussions</strong>: https://github.com/your-org/data-bridge/discussions</li>
<li><strong>Email</strong>: support@your-org.com</li>
</ul>
<h3 id="reporting-bugs">Reporting Bugs<a class="headerlink" href="#reporting-bugs" title="Permanent link">&para;</a></h3>
<p>When reporting telemetry-related issues, include:</p>
<ol>
<li>OpenTelemetry SDK version</li>
<li>data-bridge version</li>
<li>Backend (Jaeger, Grafana, etc.)</li>
<li>Configuration (environment variables)</li>
<li>Minimal reproduction example</li>
<li>Error messages/logs</li>
</ol>
<p><strong>Example bug report</strong>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a><span class="gu">## Description</span>
<a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a>Spans not appearing in Jaeger
<a id="__codelineno-151-3" name="__codelineno-151-3" href="#__codelineno-151-3"></a>
<a id="__codelineno-151-4" name="__codelineno-151-4" href="#__codelineno-151-4"></a><span class="gu">## Environment</span>
<a id="__codelineno-151-5" name="__codelineno-151-5" href="#__codelineno-151-5"></a><span class="k">-</span><span class="w"> </span>data-bridge: 0.1.0
<a id="__codelineno-151-6" name="__codelineno-151-6" href="#__codelineno-151-6"></a><span class="k">-</span><span class="w"> </span>opentelemetry-sdk: 1.28.0
<a id="__codelineno-151-7" name="__codelineno-151-7" href="#__codelineno-151-7"></a><span class="k">-</span><span class="w"> </span>Backend: Jaeger 1.50.0
<a id="__codelineno-151-8" name="__codelineno-151-8" href="#__codelineno-151-8"></a>
<a id="__codelineno-151-9" name="__codelineno-151-9" href="#__codelineno-151-9"></a><span class="gu">## Configuration</span>
<a id="__codelineno-151-10" name="__codelineno-151-10" href="#__codelineno-151-10"></a>export DATA_BRIDGE_TRACING_ENABLED=true
<a id="__codelineno-151-11" name="__codelineno-151-11" href="#__codelineno-151-11"></a>export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
<a id="__codelineno-151-12" name="__codelineno-151-12" href="#__codelineno-151-12"></a>
<a id="__codelineno-151-13" name="__codelineno-151-13" href="#__codelineno-151-13"></a><span class="gu">## Steps to Reproduce</span>
<a id="__codelineno-151-14" name="__codelineno-151-14" href="#__codelineno-151-14"></a><span class="k">1.</span> Configure telemetry as in quickstart
<a id="__codelineno-151-15" name="__codelineno-151-15" href="#__codelineno-151-15"></a><span class="k">2.</span> Run query: session.find(User).to_list()
<a id="__codelineno-151-16" name="__codelineno-151-16" href="#__codelineno-151-16"></a><span class="k">3.</span> Check Jaeger UI - no traces
<a id="__codelineno-151-17" name="__codelineno-151-17" href="#__codelineno-151-17"></a>
<a id="__codelineno-151-18" name="__codelineno-151-18" href="#__codelineno-151-18"></a><span class="gu">## Expected Behavior</span>
<a id="__codelineno-151-19" name="__codelineno-151-19" href="#__codelineno-151-19"></a>Traces appear in Jaeger
<a id="__codelineno-151-20" name="__codelineno-151-20" href="#__codelineno-151-20"></a>
<a id="__codelineno-151-21" name="__codelineno-151-21" href="#__codelineno-151-21"></a><span class="gu">## Actual Behavior</span>
<a id="__codelineno-151-22" name="__codelineno-151-22" href="#__codelineno-151-22"></a>No traces exported
</code></pre></div></p>
<hr />
<p><strong>Last Updated</strong>: 2026-01-06</p>
<p><strong>Version</strong>: 1.0.0</p>
<p><strong>License</strong>: MIT</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>